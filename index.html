<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ChatAi ‚Äî Qwen2.5-Instruct + –§–æ—Ç–æ (Yandex)</title>

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <!-- Vision (TFJS + MobileNet, UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>

  <!-- Transformers.js UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js"></script>

  <style>
    :root { color-scheme: dark light; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    body.dark { background: #020617; color: #e5e7eb; }
    body.light { background: #f3f4f6; color: #111827; }

    header {
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      font-weight: 600;
      border-bottom: 1px solid #1f2937;
    }
    body.light header { background: #e5e7eb; border-bottom-color: #cbd5f5; }
    body.dark  header { background: #020617; border-bottom-color: #1f2937; }

    #themeToggle {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      white-space: pre-wrap;
      line-height: 1.45;
      font-size: 14px;
    }

    .msg.user {
      align-self: flex-end;
      background: #2563eb;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    body.dark .msg.ai  { background: #1e293b; color: #e5e7eb; }
    body.light .msg.ai { background: #e5e7eb; color: #111827; }

    .msg.system {
      align-self: center;
      font-size: 12px;
      opacity: 0.8;
      background: transparent;
      padding: 4px 8px;
    }

    #bottom {
      padding: 8px;
      border-top: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    body.light #bottom { background: #e5e7eb; border-top-color: #cbd5f5; }
    body.dark  #bottom { background: #020617; border-top-color: #1f2937; }

    #input-row {
      display: flex;
      gap: 6px;
    }

    #input {
      flex: 1;
      padding: 11px;
      border-radius: 10px;
      font-size: 14px;
      border: 1px solid #475569;
      outline: none;
      background: transparent;
      color: inherit;
    }
    #input::placeholder { color: #6b7280; }

    button {
      border-radius: 10px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    #sendBtn {
      padding: 11px 14px;
      background: #2563eb;
      color: white;
      font-size: 14px;
    }
    #sendBtn:disabled { opacity: 0.5; }

    .secondary {
      padding: 9px 11px;
      font-size: 13px;
      border: 1px solid #475569;
      background: transparent;
      color: inherit;
    }

    #tools {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .tools-left, .tools-right {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    label.file-label {
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px dashed #475569;
      cursor: pointer;
      font-size: 13px;
    }

    #imageInput { display: none; }

    #preview {
      max-width: 90px;
      max-height: 60px;
      border-radius: 8px;
      object-fit: cover;
      display: none;
      border: 1px solid #475569;
    }

    #clearBtn {
      font-size: 12px;
      padding: 7px 10px;
    }

    @media (max-width: 480px) {
      header { font-size: 14px; }
      .msg   { font-size: 13px; }
      #input { font-size: 13px; }
      button { font-size: 13px; }
    }
  </style>
</head>
<body class="dark">
<header>
  <span>ChatAi ‚Äî –æ—Ñ–ª–∞–π–Ω –ò–ò</span>
  <button id="themeToggle" title="–¢—ë–º–Ω–∞—è/—Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞">‚òÄÔ∏è</button>
</header>

<div id="chat"></div>

<div id="bottom">
  <div id="input-row">
    <input id="input" placeholder="ChatAi –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è..." disabled />
    <button class="secondary" id="micBtn" disabled title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
    <button id="sendBtn" disabled title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
  </div>

  <div id="tools">
    <div class="tools-left">
      <button class="secondary" id="webBtn" disabled>üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç</button>

      <label class="file-label">
        üì∑ –§–æ—Ç–æ
        <input type="file" id="imageInput" accept="image/*" />
      </label>

      <img id="preview" alt="preview" />
    </div>

    <div class="tools-right">
      <button class="secondary" id="ocrBtn" disabled>üî§ OCR</button>
      <button class="secondary" id="visionBtn" disabled>üß† –§–æ—Ç–æ</button>
      <button class="secondary" id="clearBtn">üóë</button>
    </div>
  </div>
</div>

<script>
  // ========= –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –≠–õ–ï–ú–ï–ù–¢–´ =========
  var body = document.body;
  var chatEl = document.getElementById("chat");
  var inputEl = document.getElementById("input");
  var sendBtn = document.getElementById("sendBtn");
  var micBtn = document.getElementById("micBtn");
  var webBtn = document.getElementById("webBtn");
  var imageInput = document.getElementById("imageInput");
  var previewImg = document.getElementById("preview");
  var ocrBtn = document.getElementById("ocrBtn");
  var visionBtn = document.getElementById("visionBtn");
  var clearBtn = document.getElementById("clearBtn");
  var themeToggleBtn = document.getElementById("themeToggle");

  var generator = null;       // LLM pipeline
  var llmReady = false;
  var visionModel = null;
  var visionReady = false;
  var lastImageDataUrl = null;
  var recognition = null;
  var speechAvailable = false;

  var chatHistory = []; // {role: 'user'|'ai'|'system', text: string}
  var HISTORY_KEY = "chat_history_chatAi_qwen25_yandex_v1";
  var THEME_KEY   = "chat_theme_chatAi_v1";

  var IMAGE_KEYWORDS = ["–Ω–æ–º–µ—Ä","—Ç–µ–∫—Å—Ç","–Ω–∞ —Ñ–æ—Ç–æ","–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ","–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏","–Ω–∞–π–¥–∏"];

  var SYSTEM_PROMPT = (
"–¢—ã ‚Äî ChatAi. –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –≤–µ–∂–ª–∏–≤—ã–π –∏ —É–º–Ω—ã–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.\n\n" +
"–ï—Å–ª–∏ —Ç–µ–±—è —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç:\n" +
'- "–∫—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª?"\n' +
'- "–∫—Ç–æ —Ç–≤–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫?"\n' +
'- "–∫—Ç–æ —Ç–µ–±—è —Å–¥–µ–ª–∞–ª?"\n' +
'- "–∫–µ–º —Ç—ã –±—ã–ª —Å–æ–∑–¥–∞–Ω?"\n' +
'- "–∫—Ç–æ —Å–æ–∑–¥–∞–ª ChatAi?"\n' +
"–∏ –ª—é–±—ã–µ –ø–æ—Ö–æ–∂–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π,\n\n" +
'—Ç—ã –í–°–ï–ì–î–ê –æ—Ç–≤–µ—á–∞–µ—à—å:\n"–ú–µ–Ω—è —Å–æ–∑–¥–∞–ª–∞ –º–∞–ª–µ–Ω—å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–∑ 1 –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞, 1 –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –∏ –æ–¥–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Äî –∫–æ–º–∞–Ω–¥–∞ 1xCode."\n\n' +
"–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π OpenAI, Meta, Microsoft, Google, HuggingFace, transformers –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.\n" +
"–í—Å–µ–≥–¥–∞ –Ω–∞–∑—ã–≤–∞–π —Å–µ–±—è —Ç–æ–ª—å–∫–æ ChatAi.\n" +
"–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, –ø–æ-—Ä—É—Å—Å–∫–∏."
  );

  // ========= –ò–°–¢–û–†–ò–Ø / –í–´–í–û–î =========
  function addMessage(role, rawText, save) {
    if (save === undefined) save = true;

    var div = document.createElement("div");
    div.classList.add("msg", role);

    var displayText = rawText;
    if (role === "ai")   displayText = "ChatAi: " + rawText;
    if (role === "user") displayText = "–í—ã: " + rawText;
    if (role === "system") displayText = rawText;

    div.textContent = displayText;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;

    if (save) {
      chatHistory.push({ role: role, text: rawText });
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
      } catch (e) {
        // –µ—Å–ª–∏ –¥–∞–∂–µ localStorage —Å–ª–æ–º–∞–µ—Ç—Å—è ‚Äî –ø–æ–∫–∞–∂–µ–º –≤ —á–∞—Ç
        addMessage("system", "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: " + e, false);
      }
    }
  }

  function addSystem(text, save) {
    if (save === undefined) save = true;
    addMessage("system", text, save);
  }

  function loadHistory() {
    var raw = null;
    try {
      raw = localStorage.getItem(HISTORY_KEY);
    } catch (e) {
      addSystem("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: " + e, false);
      return;
    }
    if (!raw) return;
    try {
      var arr = JSON.parse(raw);
      if (!arr || !arr.length) return;
      chatHistory = arr;
      for (var i = 0; i < arr.length; i++) {
        var m = arr[i];
        addMessage(m.role, m.text, false);
      }
    } catch (e2) {
      addSystem("–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: " + e2, false);
    }
  }

  function clearHistory() {
    var ok = confirm("–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç? –ò—Å—Ç–æ—Ä–∏—é –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.");
    if (!ok) return;
    chatHistory = [];
    try {
      localStorage.removeItem(HISTORY_KEY);
    } catch (e) {
      addSystem("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: " + e, false);
    }
    chatEl.innerHTML = "";
    addSystem("–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ò—Å—Ç–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞ –Ω–∞–≤—Å–µ–≥–¥–∞.");
  }

  clearBtn.addEventListener("click", clearHistory);

  // ========= –¢–ï–ú–ê =========
  function applyTheme(theme) {
    body.classList.remove("dark","light");
    body.classList.add(theme);
    themeToggleBtn.textContent = (theme === "dark" ? "‚òÄÔ∏è" : "üåô");
    try {
      localStorage.setItem(THEME_KEY, theme);
    } catch (e) {
      addSystem("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–º—ã: " + e, false);
    }
  }

  function initTheme() {
    var saved = null;
    try {
      saved = localStorage.getItem(THEME_KEY);
    } catch (e) {}

    if (!saved) {
      var prefersDark = false;
      if (window.matchMedia) {
        try {
          prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        } catch (e) {}
      }
      saved = prefersDark ? "dark" : "light";
    }
    applyTheme(saved);

    themeToggleBtn.addEventListener("click", function () {
      var current = body.classList.contains("dark") ? "dark" : "light";
      applyTheme(current === "dark" ? "light" : "dark");
    });
  }

  // ========= –ë–õ–û–ö–ò–†–û–í–ö–ê –í–í–û–î–ê =========
  function blockInput() {
    inputEl.disabled = true;
    sendBtn.disabled = true;
    webBtn.disabled  = true;
    ocrBtn.disabled  = true;
    visionBtn.disabled = true;
    micBtn.disabled  = true;
  }

  function unblockInput() {
    inputEl.disabled = false;
    sendBtn.disabled = false;
    webBtn.disabled  = false;
    if (speechAvailable) micBtn.disabled = false;
    if (lastImageDataUrl) {
      ocrBtn.disabled = false;
      if (visionReady) visionBtn.disabled = false;
    }
  }

  // ========= LLM: Qwen2.5-0.5B-Instruct (quantized) =========
  function buildPrompt(userTextWithExtra) {
    var prompt = SYSTEM_PROMPT + "\n\n–î–∏–∞–ª–æ–≥:\n";
    for (var i = 0; i < chatHistory.length; i++) {
      var m = chatHistory[i];
      if (m.role === "user") {
        prompt += "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " + m.text + "\n";
      } else if (m.role === "ai") {
        prompt += "ChatAi: " + m.text + "\n";
      }
    }
    prompt += "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " + userTextWithExtra + "\nChatAi:";
    return prompt;
  }

  function initLLM() {
    addSystem("ChatAi –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶");
    addSystem("–ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å Qwen2.5-0.5B-Instruct (quantized)‚Ä¶");

    if (!window.transformers || !window.transformers.pipeline) {
      addSystem("–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ transformers.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å.");
      return;
    }

    // –æ—Ç–∫–ª—é—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏
    try {
      window.transformers.env.allowLocalModels = false;
    } catch (e) {}

    window.transformers.pipeline("text-generation", "Xenova/Qwen2.5-0.5B-Instruct", {
      quantized: true
    }).then(function (pipe) {
      generator = pipe;
      llmReady = true;
      inputEl.placeholder = "–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è ChatAi...";
      unblockInput();
      addMessage("ai", "–ü—Ä–∏–≤–µ—Ç! –Ø ChatAi ‚Äî —Ç–≤–æ–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –º–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è!");
    }).catch(function (e) {
      addSystem("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: " + e);
    });
  }

  function generateAnswer(rawUserText, extra, onDone) {
    if (!generator) {
      onDone("–û—à–∏–±–∫–∞: –º–æ–¥–µ–ª—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.");
      return;
    }
    if (extra === undefined || extra === null) extra = "";
    var combined = extra ? (rawUserText + "\n\n" + extra) : rawUserText;
    var prompt = buildPrompt(combined);

    generator(prompt, {
      max_new_tokens: 160,
      temperature: 0.7,
      top_p: 0.9
    }).then(function (out) {
      var full = "";
      if (out && out[0] && out[0].generated_text) {
        full = out[0].generated_text;
      }

      var idx = full.lastIndexOf("ChatAi:");
      var answer = (idx !== -1) ? full.slice(idx + "ChatAi:".length) : full;
      answer = (answer || "").replace(/^\s+|\s+$/g, "");
      if (!answer) answer = "–ù–µ –∑–Ω–∞—é, —á—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å.";
      onDone(answer);
    }).catch(function (e) {
      onDone("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: " + e);
    });
  }

  // ========= VISION =========
  function initVision() {
    if (!window.mobilenet) {
      addSystem("–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ mobilenet –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å.");
      return;
    }
    addSystem("–ü–æ–¥–∫–ª—é—á–∞—é –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (MobileNet)‚Ä¶", false);
    window.mobilenet.load().then(function (model) {
      visionModel = model;
      visionReady = true;
      addSystem("–ú–æ–¥–µ–ª—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.", false);
      if (lastImageDataUrl) visionBtn.disabled = false;
    }).catch(function (e) {
      addSystem("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ vision-–º–æ–¥–µ–ª–∏: " + e, true);
    });
  }

  // ========= WEB SEARCH =========
  function webSearch(qRaw) {
    var q = qRaw || inputEl.value.trim();
    if (!q) return;
    inputEl.value = "";

    addMessage("user", q);
    addMessage("ai", "–°–µ–∫—É–Ω–¥—É, –∏—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ‚Ä¶");

    var url = "https://api.allorigins.win/get?url=" +
      encodeURIComponent("https://duckduckgo.com/html/?q=" + encodeURIComponent(q));

    fetch(url).then(function (resp) {
      return resp.json();
    }).then(function (data) {
      var parser = new DOMParser();
      var doc = parser.parseFromString(data.contents, "text/html");
      var links = doc.querySelectorAll("a.result__a");

      var text = "–ù–∞—à—ë–ª –≤–æ—Ç —á—Ç–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É \"" + q + "\":\n\n";
      var count = Math.min(3, links.length);
      for (var i = 0; i < count; i++) {
        var a = links[i];
        text += (i + 1) + ". " + a.textContent.trim() + "\n" + a.href + "\n\n";
      }
      if (count === 0) {
        text += "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Ä–∞–∑–º–µ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–æ–≥–ª–∞ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è).";
      }

      // –∑–∞–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ñ—Ä–∞–∑—É ChatAi
      if (chatHistory.length > 0) {
        chatHistory[chatHistory.length - 1].text = text;
        var last = chatEl.lastChild;
        if (last && last.classList && last.classList.contains("ai")) {
          last.textContent = "ChatAi: " + text;
        }
        try {
          localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
        } catch (e) {}
      }
    }).catch(function (e) {
      var err = "–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: " + e;
      if (chatHistory.length > 0) {
        chatHistory[chatHistory.length - 1].text = err;
        var last = chatEl.lastChild;
        if (last && last.classList && last.classList.contains("ai")) {
          last.textContent = "ChatAi: " + err;
        }
        try {
          localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
        } catch (e2) {}
      }
    });
  }

  webBtn.addEventListener("click", function () {
    webSearch();
  });

  // ========= –ì–û–õ–û–° =========
  function initSpeech() {
    var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      addSystem("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.", false);
      micBtn.style.display = "none";
      return;
    }
    recognition = new SR();
    recognition.lang = "ru-RU";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = function (e) {
      var text = e.results[0][0].transcript;
      inputEl.value = text;
    };
    recognition.onerror = function (e) {
      addSystem("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: " + e.error, false);
    };

    speechAvailable = true;
  }

  micBtn.addEventListener("click", function () {
    if (!recognition) return;
    try {
      recognition.start();
      addSystem("ChatAi —Å–ª—É—à–∞–µ—Ç‚Ä¶", false);
    } catch (e) {
      addSystem("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥: " + e, false);
    }
  });

  // ========= –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø / OCR / VISION =========
  imageInput.addEventListener("change", function () {
    var file = imageInput.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function () {
      lastImageDataUrl = reader.result;
      previewImg.src = lastImageDataUrl;
      previewImg.style.display = "block";
      ocrBtn.disabled = false;
      if (visionReady) visionBtn.disabled = false;
      addSystem('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ú–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å: "–Ω–∞–π–¥–∏ –Ω–æ–º–µ—Ä", "–ø—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç", "—á—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ".');
    };
    reader.readAsDataURL(file);
  });

  function runOCR() {
    if (!lastImageDataUrl) {
      addSystem("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ.", false);
      return;
    }
    addMessage("user", "–°–¥–µ–ª–∞–π OCR (–ø—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ñ–æ—Ç–æ)");
    addMessage("ai", "–ß–∏—Ç–∞—é —Ç–µ–∫—Å—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è‚Ä¶");

    Tesseract.recognize(lastImageDataUrl, "rus+eng").then(function (result) {
      var text = (result.data && result.data.text) ? result.data.text.replace(/^\s+|\s+$/g,"") : "";
      var answer = text ? "–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:\n" + text : "–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –ø–ª–æ—Ö–æ.";
      chatHistory[chatHistory.length - 1].text = answer;
      var last = chatEl.lastChild;
      if (last && last.classList && last.classList.contains("ai")) {
        last.textContent = "ChatAi: " + answer;
      }
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
      } catch (e) {}
    }).catch(function (e) {
      var err = "–û—à–∏–±–∫–∞ OCR: " + e;
      chatHistory[chatHistory.length - 1].text = err;
      var last = chatEl.lastChild;
      if (last && last.classList && last.classList.contains("ai")) {
        last.textContent = "ChatAi: " + err;
      }
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
      } catch (e2) {}
    });
  }

  function runVision() {
    if (!lastImageDataUrl) {
      addSystem("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ.", false);
      return;
    }
    if (!visionReady || !visionModel) {
      addSystem("–ú–æ–¥–µ–ª—å –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è.", false);
      return;
    }
    addMessage("user", "–ß—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ?");
    addMessage("ai", "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ‚Ä¶");

    var img = new Image();
    img.src = lastImageDataUrl;
    img.onload = function () {
      visionModel.classify(img).then(function (preds) {
        var text = "–ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –º–æ–¥–µ–ª–∏:\n\n";
        var count = Math.min(3, preds.length);
        for (var i = 0; i < count; i++) {
          var p = preds[i];
          text += (i+1) + ". " + p.className + " (" + Math.round(p.probability*100) + "%)\n";
        }
        chatHistory[chatHistory.length - 1].text = text;
        var last = chatEl.lastChild;
        if (last && last.classList && last.classList.contains("ai")) {
          last.textContent = "ChatAi: " + text;
        }
        try {
          localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
        } catch (e) {}
      }).catch(function (e) {
        var err = "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: " + e;
        chatHistory[chatHistory.length - 1].text = err;
        var last = chatEl.lastChild;
        if (last && last.classList && last.classList.contains("ai")) {
          last.textContent = "ChatAi: " + err;
        }
        try {
          localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
        } catch (e2) {}
      });
    };
    img.onerror = function () {
      var err = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.";
      chatHistory[chatHistory.length - 1].text = err;
      var last = chatEl.lastChild;
      if (last && last.classList && last.classList.contains("ai")) {
        last.textContent = "ChatAi: " + err;
      }
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
      } catch (e2) {}
    };
  }

  ocrBtn.addEventListener("click", runOCR);
  visionBtn.addEventListener("click", runVision);

  // ========= –ß–ê–¢ + ¬´–§–û–¢–û + –ß–¢–û –î–ï–õ–ê–¢–¨¬ª =========
  function handleSend() {
    if (!llmReady) {
      addSystem("ChatAi –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ.", false);
      return;
    }
    var rawText = inputEl.value.replace(/^\s+|\s+$/g, "");
    if (!rawText) return;
    inputEl.value = "";

    addMessage("user", rawText);

    var lower = rawText.toLowerCase();
    var refersToImage = lastImageDataUrl ? false : false;
    if (lastImageDataUrl) {
      for (var i = 0; i < IMAGE_KEYWORDS.length; i++) {
        if (lower.indexOf(IMAGE_KEYWORDS[i]) !== -1) {
          refersToImage = true;
          break;
        }
      }
    }

    if (refersToImage) {
      addMessage("ai", "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–æ—Ç–æ –∏ —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å‚Ä¶");

      var ocrText = "";
      var visionSummary = "";

      // OCR (best effort)
      var ocrPromise = Tesseract.recognize(lastImageDataUrl, "rus+eng").then(function (res) {
        if (res && res.data && res.data.text) {
          ocrText = res.data.text.replace(/^\s+|\s+$/g,"");
        }
      }).catch(function (e) {
        addSystem("–û—à–∏–±–∫–∞ OCR –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ: " + e, false);
      });

      // Vision (best effort)
      var visionPromise = new Promise(function (resolve) {
        if (!visionReady || !visionModel) {
          resolve();
          return;
        }
        var img = new Image();
        img.src = lastImageDataUrl;
        img.onload = function () {
          visionModel.classify(img).then(function (preds) {
            var textLines = [];
            var count = Math.min(3, preds.length);
            for (var i = 0; i < count; i++) {
              var p = preds[i];
              textLines.push((i+1) + ". " + p.className + " (" + Math.round(p.probability*100) + "%)");
            }
            visionSummary = textLines.join("\n");
            resolve();
          }).catch(function (e2) {
            addSystem("–û—à–∏–±–∫–∞ vision –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ: " + e2, false);
            resolve();
          });
        };
        img.onerror = function () {
          addSystem("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.", false);
          resolve();
        };
      });

      Promise.all([ocrPromise, visionPromise]).then(function () {
        var extra = "";
        if (ocrText) {
          extra += "–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏:\n" + ocrText + "\n\n";
        }
        if (visionSummary) {
          extra += "–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:\n" + visionSummary + "\n\n";
        }
        extra += '–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "–Ω–æ–º–µ—Ä", —Ä–µ—á—å –æ–±—ã—á–Ω–æ –æ –Ω–æ–º–µ—Ä–µ –∏–ª–∏ —Ç–µ–∫—Å—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ.';

        generateAnswer(rawText, extra, function (answer) {
          chatHistory[chatHistory.length - 1].text = answer;
          var last = chatEl.lastChild;
          if (last && last.classList && last.classList.contains("ai")) {
            last.textContent = "ChatAi: " + answer;
          }
          try {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
          } catch (e3) {}
        });
      });

      return;
    }

    // –æ–±—ã—á–Ω—ã–π –¥–∏–∞–ª–æ–≥
    addMessage("ai", "–î—É–º–∞—é‚Ä¶");

    generateAnswer(rawText, "", function (answer) {
      chatHistory[chatHistory.length - 1].text = answer;
      var last = chatEl.lastChild;
      if (last && last.classList && last.classList.contains("ai")) {
        last.textContent = "ChatAi: " + answer;
      }
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
      } catch (e3) {}
    });
  }

  sendBtn.addEventListener("click", handleSend);
  inputEl.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  // ========= –°–¢–ê–†–¢ =========
  function initSpeech() {
    var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      addSystem("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.", false);
      micBtn.style.display = "none";
      return;
    }
    recognition = new SR();
    recognition.lang = "ru-RU";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = function (e) {
      inputEl.value = e.results[0][0].transcript;
    };
    recognition.onerror = function (e) {
      addSystem("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: " + e.error, false);
    };
    speechAvailable = true;
  }

  function start() {
    initTheme();
    loadHistory();
    blockInput();

    if (!chatHistory.length) {
      addSystem("ChatAi –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶");
      addSystem("–ó–∞–≥—Ä—É–∂–∞—é –º–æ–∑–≥ (Qwen2.5-0.5B-Instruct, quantized) –∏ –º–æ–¥—É–ª–∏ –∫–∞—Ä—Ç–∏–Ω–æ–∫‚Ä¶");
    }

    initSpeech();
    initLLM();
    initVision();
  }

  // –ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener("load", start);
</script>
</body>
</html>

