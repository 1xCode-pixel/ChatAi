<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChatAi ‚Äî OpenRouter LLaMA 70B / 8B</title>

  <style>
    :root { color-scheme: dark light; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    body.dark { background: #020617; color: #e5e7eb; }
    body.light { background: #f3f4f6; color: #111827; }

    header {
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #1f2937;
      font-size: 14px;
      font-weight: 600;
    }

    #themeToggle {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 20px;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      white-space: pre-wrap;
      line-height: 1.45;
      font-size: 14px;
    }

    .msg.user {
      align-self: flex-end;
      background: #2563eb;
      color: #fff;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 4px rgba(15,23,42,.45);
    }

    .msg.ai {
      align-self: flex-start;
      background: #1e293b;
      color: #e5e7eb;
      box-shadow: 0 2px 4px rgba(15,23,42,.45);
    }
    body.light .msg.ai {
      background: #e5e7eb;
      color: #111827;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
    }

    .msg.system {
      align-self: center;
      font-size: 12px;
      opacity: 0.8;
      background: transparent;
      padding: 4px 8px;
    }

    .msg.error {
      border: 1px solid #dc2626;
      background: rgba(220,38,38,0.12);
      color: #fecaca;
    }
    body.light .msg.error {
      background: #fee2e2;
      color: #7f1d1d;
    }

    .typing-dot {
      display:inline-block;
      width:4px; height:4px;
      margin:0 1px;
      border-radius:999px;
      background: currentColor;
      animation: bounce 1s infinite;
    }
    .typing-dot:nth-child(2){ animation-delay:.2s; }
    .typing-dot:nth-child(3){ animation-delay:.4s; }

    @keyframes bounce {
      0%,80%,100% { transform: translateY(0); opacity:.4; }
      40% { transform: translateY(-3px); opacity:1; }
    }

    #bottom {
      padding: 8px;
      border-top: 1px solid #1f2937;
    }

    #input-row {
      display:flex;
      gap:6px;
      margin-bottom:6px;
    }

    #input {
      flex:1;
      padding:11px;
      border-radius:10px;
      border:1px solid #475569;
      background:transparent;
      color:inherit;
      font-size:14px;
    }
    #input::placeholder { color:#6b7280; }

    button {
      border-radius:10px;
      border:none;
      padding:8px 12px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
    }

    #sendBtn {
      background:#2563eb;
      color:white;
    }
    #sendBtn:disabled { opacity:.5; }

    .secondary {
      border:1px solid #475569;
      background:transparent;
      color:inherit;
    }

    #webBtn {
      margin-right:6px;
    }

    #clearBtn {
      font-size:12px;
      padding:6px 10px;
    }

    @media (max-width:480px){
      header { font-size:13px; }
      .msg   { font-size:13px; }
      #input { font-size:13px; }
      button { font-size:12px; padding:7px 10px; }
    }
  </style>
</head>

<body class="dark">
<header>
  <span id="title">ChatAi ‚Äî –ø–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ OpenRouter‚Ä¶</span>
  <button id="themeToggle">‚òÄÔ∏è</button>
</header>

<div id="chat"></div>

<div id="bottom">
  <div id="input-row">
    <input id="input" placeholder="ChatAi –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶" disabled />
    <button class="secondary" id="micBtn" disabled title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
    <button id="sendBtn" disabled>‚û§</button>
  </div>
  <div style="display:flex;justify-content:space-between;gap:6px;flex-wrap:wrap;">
    <div>
      <button class="secondary" id="webBtn" disabled>üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫</button>
    </div>
    <button class="secondary" id="clearBtn">üóë –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
  </div>
</div>

<script>
  // ‚ö† –°–Æ–î–ê –í–°–¢–ê–í–¨ –ù–û–í–´–ô –ö–õ–Æ–ß OpenRouter
  // –ù–∞–ø—Ä–∏–º–µ—Ä: sk-or-v1-xxxxxxxxxxxxxx
  const OPENROUTER_API_KEY = "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";

  // –ú–æ–¥–µ–ª–∏ (–º–æ–∂–µ—à—å –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ –¥—Ä—É–≥–∏–µ –∏–∑ OpenRouter)
  const MODEL_PC     = "meta-llama/Meta-Llama-3.1-70B-Instruct";
  const MODEL_MOBILE = "meta-llama/Meta-Llama-3.1-8B-Instruct";

  const isMobile = /Android|iPhone|iPad|Mobile/i.test(navigator.userAgent);
  const CURRENT_MODEL = isMobile ? MODEL_MOBILE : MODEL_PC;

  const chatEl   = document.getElementById("chat");
  const inputEl  = document.getElementById("input");
  const sendBtn  = document.getElementById("sendBtn");
  const micBtn   = document.getElementById("micBtn");
  const webBtn   = document.getElementById("webBtn");
  const clearBtn = document.getElementById("clearBtn");
  const themeBtn = document.getElementById("themeToggle");
  const titleEl  = document.getElementById("title");

  const HISTORY_KEY = "chatai_openrouter_history_v1";
  const THEME_KEY   = "chatai_theme_v1";
  let chatHistory = []; // {role:'user'|'assistant', text}
  let recognition = null;

  function vibrate(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){} }
  function scrollBottom(){ chatEl.scrollTop = chatEl.scrollHeight; }

  function addMessage(role, text, {save=true, extraClass} = {}) {
    const div = document.createElement("div");
    div.classList.add("msg", role);
    if(extraClass) div.classList.add(extraClass);

    let display = text;
    if(role === "ai")   display = "ChatAi: " + text;
    if(role === "user") display = "–í—ã: " + text;

    div.textContent = display;
    chatEl.appendChild(div);
    scrollBottom();

    if(save && (role === "user" || role === "ai")) {
      const mapped = role === "ai" ? "assistant" : "user";
      chatHistory.push({role: mapped, text});
      try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory)); }catch(e){}
    }
    return div;
  }

  function addSystem(text, opts){ return addMessage("system", text, opts); }

  // –ò—Å—Ç–æ—Ä–∏—è
  (function loadHistory(){
    let raw = null;
    try{ raw = localStorage.getItem(HISTORY_KEY); }catch(e){}
    if(!raw) return;
    try{
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return;
      chatHistory = arr;
      arr.forEach(m=>{
        if(m.role === "assistant") addMessage("ai", m.text, {save:false});
        else if(m.role === "user") addMessage("user", m.text, {save:false});
      });
    }catch(e){
      addSystem("–û—à–∏–±–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏: "+e, {save:false});
    }
  })();

  clearBtn.addEventListener("click", ()=>{
    if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç –∏ –∏—Å—Ç–æ—Ä–∏—é?")) return;
    chatHistory = [];
    try{ localStorage.removeItem(HISTORY_KEY); }catch(e){}
    chatEl.innerHTML = "";
    addSystem("–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.");
  });

  // –¢–µ–º–∞
  (function initTheme(){
    let t = "dark";
    try{
      const saved = localStorage.getItem(THEME_KEY);
      if(saved) t = saved;
      else if(window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches){
        t = "light";
      }
    }catch(e){}
    document.body.classList.remove("dark","light");
    document.body.classList.add(t);
    themeBtn.textContent = t === "dark" ? "‚òÄÔ∏è" : "üåô";
  })();

  themeBtn.addEventListener("click", ()=>{
    const cur  = document.body.classList.contains("dark") ? "dark" : "light";
    const next = cur === "dark" ? "light" : "dark";
    document.body.classList.remove("dark","light");
    document.body.classList.add(next);
    themeBtn.textContent = next === "dark" ? "‚òÄÔ∏è" : "üåô";
    try{ localStorage.setItem(THEME_KEY, next); }catch(e){}
  });

  // –ì–æ–ª–æ—Å
  (function initSpeech(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ micBtn.style.display="none"; return; }
    recognition = new SR();
    recognition.lang = "ru-RU";
    recognition.interimResults = false;
    recognition.onresult = e=>{
      inputEl.value = e.results[0][0].transcript;
    };
    recognition.onerror = e=>{
      addSystem("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: "+e.error, {save:false});
    };
    micBtn.disabled = false;
  })();

  micBtn.addEventListener("click", ()=>{
    if(!recognition) return;
    try{
      recognition.start();
      addSystem("–°–ª—É—à–∞—é‚Ä¶", {save:false});
    }catch(e){
      addSystem("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: "+e, {save:false});
    }
  });

  // –ü—Ä–æ–º–ø—Ç
  function buildMessages(userText){
    const systemPrompt = `
–¢—ã ‚Äî ChatAi, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.

–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç, –∫—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª, –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π:
"–ú–µ–Ω—è —Å–æ–∑–¥–∞–ª–∞ –º–∞–ª–µ–Ω—å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–∑ 1 –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞, 1 –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –∏ –æ–¥–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Äî –∫–æ–º–∞–Ω–¥–∞ 1xCode."

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, –ø–æ-—Ä—É—Å—Å–∫–∏. –ù–µ —É–ø–æ–º–∏–Ω–∞–π OpenAI, OpenRouter –∏ –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö.
`.trim();

    const msgs = [{ role: "system", content: systemPrompt }];

    chatHistory.forEach(m=>{
      msgs.push({ role: m.role, content: m.text });
    });

    msgs.push({ role: "user", content: userText });
    return msgs;
  }

  // –í—ã–∑–æ–≤ OpenRouter
  async function callOpenRouter(userText){
    if(!OPENROUTER_API_KEY || OPENROUTER_API_KEY === "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"){
      throw new Error("API –∫–ª—é—á OpenRouter –Ω–µ –∑–∞–¥–∞–Ω –≤ –∫–æ–¥–µ.");
    }

    const body = {
      model: CURRENT_MODEL,
      messages: buildMessages(userText),
      temperature: 0.7,
      max_tokens: 700
    };

    const resp = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + OPENROUTER_API_KEY,
        "Content-Type": "application/json",
        // —ç—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ OpenRouter —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–∞–∫
        "HTTP-Referer": "https://1xcode-pixel.github.io/ChatAi/",
        "X-Title": "ChatAi"
      },
      body: JSON.stringify(body)
    });

    if(!resp.ok){
      const txt = await resp.text();
      throw new Error("HTTP "+resp.status+": "+txt);
    }

    const data = await resp.json();
    const choice = data.choices && data.choices[0];
    if(!choice || !choice.message || !choice.message.content){
      throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏.");
    }
    return choice.message.content.trim();
  }

  // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏
  function typeText(div, full, done){
    const prefix = "ChatAi: ";
    let i = 0;
    const clean = full;
    const id = setInterval(()=>{
      if(i >= clean.length){
        div.textContent = prefix + clean;
        clearInterval(id);
        if(done) done();
        return;
      }
      div.textContent = prefix + clean.slice(0, i+1);
      i++;
      scrollBottom();
    }, 18);
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞
  async function handleSend(){
    const text = inputEl.value.trim();
    if(!text) return;
    inputEl.value = "";
    vibrate(20);

    addMessage("user", text);

    const typing = document.createElement("div");
    typing.classList.add("msg","ai");
    typing.innerHTML = 'ChatAi: <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
    chatEl.appendChild(typing);
    scrollBottom();

    try{
      const answer = await callOpenRouter(text);
      chatHistory.push({role:"assistant", text:answer});
      try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory)); }catch(e){}
      typeText(typing, answer, ()=>vibrate(10));
    }catch(e){
      typing.textContent = "ChatAi: –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞: " + e.message;
      typing.classList.add("error");
      vibrate(60);
    }
  }

  sendBtn.addEventListener("click", handleSend);
  inputEl.addEventListener("keydown", e=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      handleSend();
    }
  });

  // –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫ (–æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π)
  webBtn.addEventListener("click", async()=>{
    const q = prompt("–ß—Ç–æ –Ω–∞–π—Ç–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ?");
    if(!q) return;
    addMessage("user", "–ù–∞–π–¥–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ: " + q);
    const aiDiv = addMessage("ai", "–ò—â—É‚Ä¶");

    try{
      const url = "https://api.allorigins.win/get?url="+
        encodeURIComponent("https://duckduckgo.com/html/?q="+encodeURIComponent(q));
      const r = await fetch(url);
      const j = await r.json();
      const doc = new DOMParser().parseFromString(j.contents, "text/html");
      const links = doc.querySelectorAll("a.result__a");
      let out = "";
      for(let i=0;i<3 && i<links.length;i++){
        out += `${i+1}. ${links[i].textContent.trim()}\n${links[i].href}\n\n`;
      }
      if(!out) out = "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à—ë–ª.";
      aiDiv.textContent = "ChatAi: " + out;
      chatHistory.push({role:"assistant", text:out});
      localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
    }catch(e){
      const msg = "–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: " + e;
      aiDiv.textContent = "ChatAi: " + msg;
    }
  });

  // –°—Ç–∞—Ä—Ç
  window.onload = ()=>{
    const label = isMobile ? "LLaMA 3.1 8B (–º–æ–±–∏–ª—å–Ω–∞—è)" : "LLaMA 3.1 70B (–ü–ö)";
    titleEl.textContent = "ChatAi ‚Äî " + label;
    if(chatHistory.length === 0){
      addSystem("–ò—Å–ø–æ–ª—å–∑—É—é –º–æ–¥–µ–ª—å: " + label);
    }

    if(!OPENROUTER_API_KEY || OPENROUTER_API_KEY === "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"){
      addSystem("‚ùó –í—Å—Ç–∞–≤—å —Å–≤–æ–π API –∫–ª—é—á OpenRouter –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É OPENROUTER_API_KEY –≤ –∫–æ–¥–µ.", {extraClass:"error"});
      return;
    }

    inputEl.disabled = false;
    sendBtn.disabled = false;
    webBtn.disabled  = false;
    inputEl.placeholder = "–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è ChatAi‚Ä¶";

    if(chatHistory.length === 0){
      addMessage("ai","–ü—Ä–∏–≤–µ—Ç! –Ø ChatAi.");
    }
  };
</script>
</body>
</html>
