<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–π –ò–ò-—Å–∞–π—Ç –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞</title>

  <!-- LLM –≤ –±—Ä–∞—É–∑–µ—Ä–µ -->
  <script src="https://unpkg.com/@mlc-ai/web-llm"></script>

  <!-- OCR –≤ –±—Ä–∞—É–∑–µ—Ä–µ -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <!-- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

  <style>
    body {
      margin: 0;
      background: #0f172a;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      padding: 12px 20px;
      border-bottom: 1px solid #1f2937;
      background: #020617;
      font-weight: 600;
      font-size: 15px;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
      font-size: 14px;
    }
    .msg.user {
      align-self: flex-end;
      background: #2563eb;
      border-bottom-right-radius: 4px;
    }
    .msg.ai {
      align-self: flex-start;
      background: #111827;
      border-bottom-left-radius: 4px;
    }
    .msg.system {
      align-self: center;
      background: transparent;
      font-size: 12px;
      color: #9ca3af;
    }
    #bottom {
      border-top: 1px solid #1f2937;
      padding: 10px;
      background: #020617;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #input-row {
      display: flex;
      gap: 8px;
    }
    #input {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
    }
    #input::placeholder {
      color: #6b7280;
    }
    button {
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      color: white;
      background: #2563eb;
      white-space: nowrap;
    }
    button.secondary {
      background: #374151;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #tools {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
      align-items: center;
      justify-content: space-between;
    }
    .left-tools, .right-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    label.file-label {
      border-radius: 8px;
      padding: 6px 10px;
      background: #111827;
      border: 1px dashed #374151;
      cursor: pointer;
      font-size: 12px;
    }
    #imageInput {
      display: none;
    }
    #preview {
      max-width: 120px;
      max-height: 80px;
      border-radius: 6px;
      border: 1px solid #374151;
      display: none;
      object-fit: cover;
    }
  </style>
</head>
<body>

<header>
  –ò–ò-—á–∞—Ç –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞: LLM + –ò–Ω—Ç–µ—Ä–Ω–µ—Ç + OCR + Vision –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
</header>

<div id="chat"></div>

<div id="bottom">
  <div id="input-row">
    <input id="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (–∏–ª–∏ /web –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞)">
    <button id="sendBtn">–í —á–∞—Ç</button>
  </div>

  <div id="tools">
    <div class="left-tools">
      <button class="secondary" id="webBtn">–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ</button>
      <label class="file-label">
        üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
        <input type="file" id="imageInput" accept="image/*">
      </label>
      <img id="preview" alt="preview">
    </div>
    <div class="right-tools">
      <button class="secondary" id="ocrBtn" disabled>OCR (—Ç–µ–∫—Å—Ç —Å —Ñ–æ—Ç–æ)</button>
      <button class="secondary" id="visionBtn" disabled>–ß—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ</button>
    </div>
  </div>
</div>

<script>
  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const webBtn = document.getElementById('webBtn');
  const imageInput = document.getElementById('imageInput');
  const previewImg = document.getElementById('preview');
  const ocrBtn = document.getElementById('ocrBtn');
  const visionBtn = document.getElementById('visionBtn');

  let llm = null;
  let llmReady = false;
  let mobilenetModel = null;
  let visionReady = false;
  let lastImageDataUrl = null;

  // ----- UI helpers -----
  function addMessage(role, text) {
    const div = document.createElement('div');
    div.classList.add('msg', role);
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function addSystem(text) {
    addMessage('system', text);
  }

  // ----- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π -----
  async function initLLM() {
    try {
      addSystem('–ó–∞–≥—Ä—É–∂–∞—é —è–∑—ã–∫–æ–≤—É—é –º–æ–¥–µ–ª—å (WebLLM)...');
      llm = await webllm.ChatModule.create("Llama-3-8B-Instruct-q4f32_1");
      llmReady = true;
      addSystem('LLM –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ú–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è.');
    } catch (e) {
      addSystem('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ LLM: ' + e);
    }
  }

  async function initVision() {
    try {
      addSystem('–ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ (MobileNet)...');
      mobilenetModel = await mobilenet.load();
      visionReady = true;
      addSystem('–ú–æ–¥–µ–ª—å –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.');
    } catch (e) {
      addSystem('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ vision-–º–æ–¥–µ–ª–∏: ' + e);
    }
  }

  // –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å—ë
  initLLM();
  initVision();
  addMessage('ai', '–ü—Ä–∏–≤–µ—Ç! –Ø –ª–æ–∫–∞–ª—å–Ω—ã–π –ò–ò.\n' +
    '–Ø —É–º–µ—é:\n' +
    '‚Ä¢ –æ—Ç–≤–µ—á–∞—Ç—å –∫–∞–∫ —á–∞—Ç-–±–æ—Ç\n' +
    '‚Ä¢ –∏—Å–∫–∞—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (–∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ¬ª –∏–ª–∏ /web –∑–∞–ø—Ä–æ—Å)\n' +
    '‚Ä¢ —á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç —Å –∫–∞—Ä—Ç–∏–Ω–æ–∫ (OCR)\n' +
    '‚Ä¢ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å, —á—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ');

  // ----- –õ–æ–≥–∏–∫–∞ —á–∞—Ç–∞ —Å –ò–ò -----
  async function handleChat() {
    const text = inputEl.value.trim();
    if (!text) return;
    inputEl.value = '';

    // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —è–≤–Ω–æ –ø–∏—à–µ—Ç /web, –∏–¥—ë–º –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
    if (text.startsWith('/web ')) {
      addMessage('user', text);
      const query = text.replace('/web', '').trim();
      await webSearch(query);
      return;
    }

    addMessage('user', text);

    if (!llmReady) {
      addMessage('ai', '–ú–æ–¥–µ–ª—å –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ‚Ä¶');
      return;
    }

    const thinkingIndex = addThinking();

    try {
      const reply = await llm.generate(text);
      replaceThinking(thinkingIndex, reply);
    } catch (e) {
      replaceThinking(thinkingIndex, '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: ' + e);
    }
  }

  function addThinking() {
    const div = document.createElement('div');
    div.classList.add('msg', 'ai');
    div.textContent = '–î—É–º–∞—é...';
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
    return Array.from(chatEl.children).indexOf(div);
  }

  function replaceThinking(index, text) {
    const node = chatEl.children[index];
    if (node) node.textContent = text;
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  // ----- –ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (—á–µ—Ä–µ–∑ allOrigins + DuckDuckGo) -----
  async function webSearch(queryRaw) {
    const query = queryRaw || inputEl.value.trim();
    if (!query) return;
    inputEl.value = '';

    addMessage('user', queryRaw ? '/web ' + query : query);

    const idx = addThinking();

    try {
      const url = 'https://api.allorigins.win/get?url=' +
        encodeURIComponent('https://duckduckgo.com/html/?q=' + encodeURIComponent(query));

      const resp = await fetch(url);
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      const html = data.contents;

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      const links = Array.from(doc.querySelectorAll('a.result__a, a.result__a'));
      let text = '–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "' + query + '"\n\n';

      for (let i = 0; i < Math.min(3, links.length); i++) {
        const a = links[i];
        const title = a.textContent.trim();
        const href = a.getAttribute('href');
        text += (i + 1) + '. ' + title + '\n' + href + '\n\n';
      }

      if (links.length === 0) {
        text += '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –í–æ–∑–º–æ–∂–Ω–æ, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–∑–º–µ–Ω–∏–ª–∞ —Ä–∞–∑–º–µ—Ç–∫—É.';
      }

      replaceThinking(idx, text);
    } catch (e) {
      replaceThinking(idx, '–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: ' + e);
    }
  }

  // ----- –†–∞–±–æ—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ -----
  imageInput.addEventListener('change', () => {
    const file = imageInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      lastImageDataUrl = reader.result;
      previewImg.src = lastImageDataUrl;
      previewImg.style.display = 'block';
      ocrBtn.disabled = false;
      visionBtn.disabled = !visionReady;
      addSystem('–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å OCR –∏–ª–∏ "–ß—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ".');
    };
    reader.readAsDataURL(file);
  });

  // OCR
  async function runOCR() {
    if (!lastImageDataUrl) {
      addSystem('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É.');
      return;
    }
    addMessage('user', '–°–¥–µ–ª–∞–π OCR (—Ä–∞—Å–ø–æ–∑–Ω–∞–π —Ç–µ–∫—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ)');
    const idx = addThinking();

    try {
      const result = await Tesseract.recognize(
        lastImageDataUrl,
        'rus+eng',
        { logger: m => console.log(m) }
      );
      const text = (result.data && result.data.text) ? result.data.text.trim() : '';
      replaceThinking(idx, text ? ('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:\n' + text) : '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –ø–ª–æ—Ö–æ.');
    } catch (e) {
      replaceThinking(idx, '–û—à–∏–±–∫–∞ OCR: ' + e);
    }
  }

  // –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: —á—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ
  async function runVision() {
    if (!lastImageDataUrl) {
      addSystem('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É.');
      return;
    }
    if (!visionReady) {
      addSystem('–ú–æ–¥–µ–ª—å –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è.');
      return;
    }

    addMessage('user', '–û–ø—Ä–µ–¥–µ–ª–∏, —á—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ');
    const idx = addThinking();

    // –≥—Ä—É–∑–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π <img>
    const img = new Image();
    img.src = lastImageDataUrl;
    img.onload = async () => {
      try {
        const predictions = await mobilenetModel.classify(img);
        let text = '–ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –º–æ–¥–µ–ª–∏:\n\n';
        predictions.slice(0, 3).forEach((p, i) => {
          text += (i + 1) + '. ' + p.className + ' (' +
            Math.round(p.probability * 100) + '%)\n';
        });
        replaceThinking(idx, text);
      } catch (e) {
        replaceThinking(idx, '–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏: ' + e);
      }
    };
    img.onerror = () => {
      replaceThinking(idx, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.');
    };
  }

  // ----- –°–æ–±—ã—Ç–∏—è -----
  sendBtn.addEventListener('click', handleChat);
  inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleChat();
    }
  });
  webBtn.addEventListener('click', () => webSearch());
  ocrBtn.addEventListener('click', runOCR);
  visionBtn.addEventListener('click', runVision);
</script>

</body>
</html>
