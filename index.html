<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <title>AI Chat ‚Äî Phi-3-mini-4k-instruct + –§–æ—Ç–æ</title>

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <!-- Vision -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

  <style>
    :root { color-scheme: dark light; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    body.dark { background: #020617; color: #e5e7eb; }
    body.light { background: #f3f4f6; color: #111827; }

    header {
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      font-weight: 600;
      border-bottom: 1px solid #1f2937;
    }
    body.light header { background: #e5e7eb; border-bottom-color: #cbd5f5; }
    body.dark header { background: #020617; border-bottom-color: #1f2937; }

    #themeToggle {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      white-space: pre-wrap;
      line-height: 1.45;
      font-size: 14px;
    }

    .msg.user {
      align-self: flex-end;
      background: #2563eb;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    body.dark .msg.ai { background: #1e293b; color: #e5e7eb; }
    body.light .msg.ai { background: #e5e7eb; color: #111827; }

    .msg.system {
      align-self: center;
      font-size: 12px;
      opacity: 0.7;
      background: transparent;
    }

    #bottom {
      padding: 8px;
      border-top: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    body.light #bottom { background: #e5e7eb; border-top-color: #cbd5f5; }
    body.dark #bottom { background: #020617; border-top-color: #1f2937; }

    #input-row {
      display: flex;
      gap: 6px;
    }

    #input {
      flex: 1;
      padding: 11px;
      border-radius: 10px;
      font-size: 14px;
      border: 1px solid #475569;
      outline: none;
      background: transparent;
      color: inherit;
    }
    #input::placeholder { color: #6b7280; }

    button {
      border-radius: 10px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    #sendBtn {
      padding: 11px 14px;
      background: #2563eb;
      color: white;
      font-size: 14px;
    }
    #sendBtn:disabled { opacity: 0.5; }

    .secondary {
      padding: 9px 11px;
      font-size: 13px;
      border: 1px solid #475569;
      background: transparent;
      color: inherit;
    }

    #tools {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .tools-left, .tools-right {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    label.file-label {
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px dashed #475569;
      cursor: pointer;
      font-size: 13px;
    }

    #imageInput { display: none; }

    #preview {
      max-width: 90px;
      max-height: 60px;
      border-radius: 8px;
      object-fit: cover;
      display: none;
      border: 1px solid #475569;
    }

    #clearBtn {
      font-size: 12px;
      padding: 7px 10px;
    }

    @media (max-width: 480px) {
      header { font-size: 14px; }
      .msg { font-size: 13px; }
      #input { font-size: 13px; }
      button { font-size: 13px; }
    }
  </style>
</head>
<body class="dark">
<header>
  <span>–ò–ò-—á–∞—Ç (Phi-3-mini-4k + —Ñ–æ—Ç–æ)</span>
  <button id="themeToggle" title="–¢—ë–º–Ω–∞—è/—Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞">‚òÄÔ∏è</button>
</header>

<div id="chat"></div>

<div id="bottom">
  <div id="input-row">
    <input id="input" placeholder="–ñ–¥–∏—Ç–µ... –ò–ò –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è" disabled />
    <button class="secondary" id="micBtn" disabled title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
    <button id="sendBtn" disabled title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
  </div>

  <div id="tools">
    <div class="tools-left">
      <button class="secondary" id="webBtn" disabled>üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç</button>

      <label class="file-label">
        üì∑ –§–æ—Ç–æ
        <input type="file" id="imageInput" accept="image/*" />
      </label>

      <img id="preview" alt="preview" />
    </div>

    <div class="tools-right">
      <button class="secondary" id="ocrBtn" disabled>üî§ OCR</button>
      <button class="secondary" id="visionBtn" disabled>üß† –§–æ—Ç–æ</button>
      <button class="secondary" id="clearBtn">üóë</button>
    </div>
  </div>
</div>

<script type="module">
  import { pipeline } from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0-alpha.17";

  // --- —ç–ª–µ–º–µ–Ω—Ç—ã ---
  const body = document.body;
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const micBtn = document.getElementById("micBtn");
  const webBtn = document.getElementById("webBtn");
  const imageInput = document.getElementById("imageInput");
  const previewImg = document.getElementById("preview");
  const ocrBtn = document.getElementById("ocrBtn");
  const visionBtn = document.getElementById("visionBtn");
  const clearBtn = document.getElementById("clearBtn");
  const themeToggleBtn = document.getElementById("themeToggle");

  // --- —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
  let generator = null;       // pipeline –¥–ª—è Phi-3-mini
  let llmReady = false;
  let visionModel = null;
  let visionReady = false;
  let lastImageDataUrl = null;
  let recognition = null;
  let speechAvailable = false;

  let chatHistory = [];
  const HISTORY_KEY = "ai_chat_history_phi3mini_v1";
  const THEME_KEY = "ai_chat_theme_v1";

  const IMAGE_KEYWORDS = [
    "–Ω–æ–º–µ—Ä","—Ç–µ–∫—Å—Ç","–Ω–∞ —Ñ–æ—Ç–æ","–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ","–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏","–Ω–∞–π–¥–∏"
  ];

  const SYSTEM_PROMPT = "–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.";

  // --- –∏—Å—Ç–æ—Ä–∏—è ---
  function addMessage(role, text, save = true) {
    const div = document.createElement("div");
    div.classList.add("msg", role);
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;

    if (save) {
      chatHistory.push({ role, text });
      localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
    }
  }

  function addSystem(text, save = true) {
    addMessage("system", text, save);
  }

  function loadHistory() {
    const raw = localStorage.getItem(HISTORY_KEY);
    if (!raw) return;
    try {
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return;
      chatHistory = arr;
      arr.forEach(m => addMessage(m.role, m.text, false));
    } catch {}
  }

  function clearHistory() {
    if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç? –ò—Å—Ç–æ—Ä–∏—é –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.")) return;
    chatHistory = [];
    localStorage.removeItem(HISTORY_KEY);
    chatEl.innerHTML = "";
    addSystem("–ß–∞—Ç –æ—á–∏—â–µ–Ω.");
  }
  clearBtn.addEventListener("click", clearHistory);

  // --- —Ç–µ–º–∞ ---
  function applyTheme(theme) {
    body.classList.remove("dark","light");
    body.classList.add(theme);
    themeToggleBtn.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem(THEME_KEY, theme);
  }
  function initTheme() {
    let saved = localStorage.getItem(THEME_KEY);
    if (!saved) {
      const prefersDark = window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;
      saved = prefersDark ? "dark" : "light";
    }
    applyTheme(saved);
    themeToggleBtn.addEventListener("click", () => {
      const cur = body.classList.contains("dark") ? "dark" : "light";
      applyTheme(cur === "dark" ? "light" : "dark");
    });
  }

  // --- –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–≤–æ–¥–∞ ---
  function blockInput() {
    inputEl.disabled = true;
    sendBtn.disabled = true;
    webBtn.disabled = true;
    ocrBtn.disabled = true;
    visionBtn.disabled = true;
    micBtn.disabled = true;
  }
  function unblockInput() {
    inputEl.disabled = false;
    sendBtn.disabled = false;
    webBtn.disabled = false;
    if (speechAvailable) micBtn.disabled = false;
    if (lastImageDataUrl) {
      ocrBtn.disabled = false;
      if (visionReady) visionBtn.disabled = false;
    }
  }

  // --- Phi-3-mini-4k-instruct –∫–∞–∫ —á–∞—Ç ---
  function buildMessages(userContent) {
    const messages = [
      { role: "system", content: SYSTEM_PROMPT },
      ...chatHistory
        .filter(m => m.role === "user" || m.role === "ai")
        .map(m => ({
          role: m.role === "ai" ? "assistant" : "user",
          content: m.text
        })),
      { role: "user", content: userContent }
    ];
    return messages;
  }

  async function initLLM() {
    addSystem("–ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å Phi-3-mini-4k-instruct... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10‚Äì40 —Å–µ–∫—É–Ω–¥.");
    try {
      generator = await pipeline("text-generation", "Xenova/Phi-3-mini-4k-instruct");
      llmReady = true;
      inputEl.placeholder = "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...";
      unblockInput();
      addMessage("ai","–ú–æ–¥–µ–ª—å Phi-3-mini-4k –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞. –ú–æ–∂–µ–º –æ–±—â–∞—Ç—å—Å—è!");
    } catch (e) {
      addSystem("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: " + e);
    }
  }

  async function generateAnswer(userText, extra = "") {
    const combined = extra ? `${userText}\n\n${extra}` : userText;
    const messages = buildMessages(combined);
    const out = await generator(messages, {
      max_new_tokens: 160,
      do_sample: true,
      temperature: 0.7,
      top_p: 0.9
    });
    const last = out[0]?.generated_text?.at(-1)?.content || "";
    return last.trim() || "–ù–µ –∑–Ω–∞—é, —á—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å.";
  }

  // --- vision ---
  async function initVision() {
    try {
      visionModel = await mobilenet.load();
      visionReady = true;
      addSystem("–ú–æ–¥–µ–ª—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (MobileNet) –∑–∞–≥—Ä—É–∂–µ–Ω–∞.", false);
      if (lastImageDataUrl) visionBtn.disabled = false;
    } catch (e) {
      addSystem("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ vision-–º–æ–¥–µ–ª–∏: " + e, false);
    }
  }

  // --- web search ---
  async function webSearch(qRaw) {
    const q = qRaw || inputEl.value.trim();
    if (!q) return;
    inputEl.value = "";

    addMessage("user","/web " + q);
    addMessage("ai","–ò—â—É –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ...");

    try {
      const url = "https://api.allorigins.win/get?url=" +
        encodeURIComponent("https://duckduckgo.com/html/?q=" + encodeURIComponent(q));
      const resp = await fetch(url);
      const data = await resp.json();

      const parser = new DOMParser();
      const doc = parser.parseFromString(data.contents,"text/html");
      const links = Array.from(doc.querySelectorAll("a.result__a"));

      let text = `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${q}":\n\n`;
      for (let i=0;i<Math.min(3,links.length);i++) {
        const a = links[i];
        text += `${i+1}. ${a.textContent.trim()}\n${a.href}\n\n`;
      }
      if (links.length === 0) {
        text += "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Ä–∞–∑–º–µ—Ç–∫–∞ –º–æ–≥–ª–∞ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è).";
      }

      chatEl.lastChild.textContent = text;
      chatHistory[chatHistory.length-1].text = text;
      localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
    } catch (e) {
      const err = "–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: " + e;
      chatEl.lastChild.textContent = err;
      chatHistory[chatHistory.length-1].text = err;
      localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
    }
  }
  webBtn.addEventListener("click", ()=>webSearch());

  // --- –≥–æ–ª–æ—Å ---
  function initSpeech() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      addSystem("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.", false);
      micBtn.style.display = "none";
      return;
    }
    recognition = new SR();
    recognition.lang = "ru-RU";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (e) => {
      const text = e.results[0][0].transcript;
      inputEl.value = text;
    };

    recognition.onerror = (e) => {
      addSystem("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: " + e.error, false);
    };

    speechAvailable = true;
  }
  micBtn.addEventListener("click", () => {
    if (!recognition) return;
    try {
      recognition.start();
      addSystem("–°–ª—É—à–∞—é...");
    } catch {}
  });

  // --- –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è / OCR / vision ---
  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      lastImageDataUrl = reader.result;
      previewImg.src = lastImageDataUrl;
      previewImg.style.display = "block";
      ocrBtn.disabled = false;
      if (visionReady) visionBtn.disabled = false;
      addSystem('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ú–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å: "–Ω–∞–π–¥–∏ –Ω–æ–º–µ—Ä", "–ø—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç", "—á—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ".');
    };
    reader.readAsDataURL(file);
  });

  async function runOCR() {
    if (!lastImageDataUrl) {
      addSystem("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ.", false);
      return;
    }
    addMessage("user","–°–¥–µ–ª–∞–π OCR —Å —Ñ–æ—Ç–æ");
    addMessage("ai","–ß–∏—Ç–∞—é —Ç–µ–∫—Å—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...");

    try {
      const result = await Tesseract.recognize(lastImageDataUrl,"rus+eng");
      const text = result.data && result.data.text ? result.data.text.trim() : "";
      const answer = text ? "–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:\n"+text : "–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –ø–ª–æ—Ö–æ.";
      chatEl.lastChild.textContent = answer;
      chatHistory[chatHistory.length-1].text = answer;
      localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
    } catch (e) {
      const err = "–û—à–∏–±–∫–∞ OCR: " + e;
      chatEl.lastChild.textContent = err;
      chatHistory[chatHistory.length-1].text = err;
      localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
    }
  }
  async function runVision() {
    if (!lastImageDataUrl) {
      addSystem("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ.", false);
      return;
    }
    if (!visionReady) {
      addSystem("–ú–æ–¥–µ–ª—å –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è.", false);
      return;
    }

    addMessage("user","–ß—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ?");
    addMessage("ai","–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...");

    const img = new Image();
    img.src = lastImageDataUrl;
    img.onload = async () => {
      try {
        const preds = await visionModel.classify(img);
        let text = "–ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –º–æ–¥–µ–ª–∏:\n\n";
        preds.slice(0,3).forEach((p,i)=>{
          text += `${i+1}. ${p.className} (${Math.round(p.probability*100)}%)\n`;
        });
        chatEl.lastChild.textContent = text;
        chatHistory[chatHistory.length-1].text = text;
        localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
      } catch (e) {
        const err = "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: " + e;
        chatEl.lastChild.textContent = err;
        chatHistory[chatHistory.length-1].text = err;
        localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
      }
    };
    img.onerror = () => {
      const err = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.";
      chatEl.lastChild.textContent = err;
      chatHistory[chatHistory.length-1].text = err;
      localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
    };
  }
  ocrBtn.addEventListener("click", runOCR);
  visionBtn.addEventListener("click", runVision);

  // --- —á–∞—Ç + ¬´—Ñ–æ—Ç–æ + –∑–∞–¥–∞–Ω–∏–µ¬ª ---
  async function handleSend() {
    if (!llmReady) {
      addSystem("–ú–æ–¥–µ–ª—å –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ.", false);
      return;
    }
    const text = inputEl.value.trim();
    if (!text) return;
    inputEl.value = "";

    addMessage("user", text);

    const lower = text.toLowerCase();
    const refersToImage = lastImageDataUrl &&
      IMAGE_KEYWORDS.some(k => lower.includes(k));

    if (refersToImage) {
      addMessage("ai","–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–æ—Ç–æ –∏ —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å...");
      let ocrText = "";
      try {
        const res = await Tesseract.recognize(lastImageDataUrl,"rus+eng");
        ocrText = res.data && res.data.text ? res.data.text.trim() : "";
      } catch {}

      let visionSummary = "";
      if (visionReady) {
        try {
          const img = new Image();
          img.src = lastImageDataUrl;
          await new Promise((res,rej)=>{img.onload=res;img.onerror=rej;});
          const preds = await visionModel.classify(img);
          visionSummary = preds.slice(0,3)
            .map((p,i)=>`${i+1}. ${p.className} (${Math.round(p.probability*100)}%)`)
            .join("\n");
        } catch {}
      }

      const extra =
        (ocrText ? "–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:\n"+ocrText+"\n\n" : "")+
        (visionSummary ? "–ß—Ç–æ –≤–∏–¥–∏—Ç –º–æ–¥–µ–ª—å:\n"+visionSummary+"\n\n" : "")+
        '–ï—Å–ª–∏ —è –ø—Ä–æ—à—É "–Ω–æ–º–µ—Ä", —á–∞—â–µ –≤—Å–µ–≥–æ —Ä–µ—á—å –æ –Ω–æ–º–µ—Ä–µ –∏–ª–∏ —Ç–µ–∫—Å—Ç–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.';

      try {
        const answer = await generateAnswer(text, extra);
        chatEl.lastChild.textContent = answer;
        chatHistory[chatHistory.length-1].text = answer;
        localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
      } catch (e) {
        const err = "–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏: " + e;
        chatEl.lastChild.textContent = err;
        chatHistory[chatHistory.length-1].text = err;
        localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
      }
      return;
    }

    // –æ–±—ã—á–Ω—ã–π —á–∞—Ç
    addMessage("ai","–î—É–º–∞—é...");
    try {
      const answer = await generateAnswer(text);
      chatEl.lastChild.textContent = answer;
      chatHistory[chatHistory.length-1].text = answer;
      localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
    } catch (e) {
      const err = "–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏: " + e;
      chatEl.lastChild.textContent = err;
      chatHistory[chatHistory.length-1].text = err;
      localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
    }
  }
  sendBtn.addEventListener("click", handleSend);
  inputEl.addEventListener("keydown", (e)=>{
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  // --- —Å—Ç–∞—Ä—Ç ---
  function initSpeech() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      addSystem("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.", false);
      micBtn.style.display = "none";
      return;
    }
    recognition = new SR();
    recognition.lang = "ru-RU";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onresult = (e)=>{
      inputEl.value = e.results[0][0].transcript;
    };
    recognition.onerror = (e)=>{
      addSystem("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: " + e.error, false);
    };
    speechAvailable = true;
  }

  micBtn.addEventListener("click", ()=>{
    if (!recognition) return;
    try { recognition.start(); addSystem("–°–ª—É—à–∞—é..."); } catch {}
  });

  (function start(){
    initTheme();
    loadHistory();
    blockInput();

    if (chatHistory.length === 0) {
      addMessage("ai","–ü—Ä–∏–≤–µ—Ç! –Ø –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ –±–∞–∑–µ Phi-3-mini-4k. –°–µ–π—á–∞—Å –∑–∞–≥—Ä—É–∂–∞—é—Å—å, –ø–æ–¥–æ–∂–¥–∏ —á—É—Ç—å-—á—É—Ç—å, –ø–æ—Ç–æ–º –º–æ–∂–µ–º –æ–±—â–∞—Ç—å—Å—è.");
    }

    initSpeech();
    initLLM();
    initVision();
  })();
</script>
</body>
</html>
