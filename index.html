<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>AI Chat ‚Äî Full Mobile Assistant</title>

<!-- --- –í–ê–ñ–ù–û! –°–¢–ê–ë–ò–õ–¨–ù–´–ô WebLLM CDN --- -->
<script src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm/dist/web-llm.min.js"></script>

<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- Vision -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

<style>
/* ----------------- –¢–ï–ú–ê –ù–ê –£–†–û–í–ù–ï CSS ----------------- */
:root {
  color-scheme: dark light;
}

/* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
body.dark {
  background: #020617;
  color: #e5e7eb;
}

/* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
body.light {
  background: #f3f4f6;
  color: #111827;
}

/* –û–±—â–∏–π —Å—Ç–∏–ª—å */
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

header {
  padding: 12px 16px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--header-bg);
}

#chat {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.msg {
  max-width: 85%;
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 15px;
  white-space: pre-wrap;
  line-height: 1.45;
}

.msg.user {
  align-self: flex-end;
  background: #2563eb;
  color: white;
  border-bottom-right-radius: 4px;
}

body.light .msg.ai {
  background: #e5e7eb;
  color: #111827;
}
body.dark .msg.ai {
  background: #1e293b;
  color: #e5e7eb;
}

.msg.system {
  align-self: center;
  opacity: 0.7;
  font-size: 13px;
}

#bottom {
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: var(--header-bg);
}

#input-row {
  display: flex;
  gap: 6px;
}

#input {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  font-size: 14px;
  border: 1px solid #475569;
  outline: none;
  background: transparent;
  color: inherit;
}

#sendBtn {
  background: #2563eb;
  color: white;
  border-radius: 10px;
  padding: 12px 16px;
  border: none;
  cursor: pointer;
}
#sendBtn:disabled {
  opacity: 0.5;
}

button.secondary {
  background: transparent;
  border: 1px solid #475569;
  color: inherit;
  border-radius: 10px;
  padding: 10px 12px;
  cursor: pointer;
}

#tools {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 8px;
}

label.file-label {
  padding: 10px 12px;
  border: 1px dashed #475569;
  border-radius: 10px;
  cursor: pointer;
}

#imageInput {
  display: none;
}

#preview {
  max-width: 90px;
  max-height: 60px;
  border-radius: 6px;
  display: none;
  border: 1px solid #475569;
}

#themeToggle {
  border: none;
  cursor: pointer;
  font-size: 18px;
  background: transparent;
}

#clearBtn {
  font-size: 12px;
  padding: 8px 12px;
}
</style>
</head>

<body class="dark">

<header>
  <span>–ò–ò-—á–∞—Ç</span>
  <button id="themeToggle">‚òÄÔ∏è</button>
</header>

<div id="chat"></div>

<div id="bottom">
  <div id="input-row">
    <input id="input" placeholder="–ñ–¥–∏—Ç–µ... –∏–¥—ë—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –ò–ò" disabled>
    <button class="secondary" id="micBtn" disabled>üé§</button>
    <button id="sendBtn" disabled>‚û§</button>
  </div>

  <div id="tools">
    <div class="left">
      <button class="secondary" id="webBtn" disabled>üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç</button>

      <label class="file-label">
        üì∑ –§–æ—Ç–æ
        <input type="file" id="imageInput" accept="image/*">
      </label>

      <img id="preview">
    </div>

    <div class="right">
      <button class="secondary" id="ocrBtn" disabled>üî§ OCR</button>
      <button class="secondary" id="visionBtn" disabled>üß† –§–æ—Ç–æ</button>
      <button class="secondary" id="clearBtn">üóë</button>
    </div>
  </div>
</div>

<script>
/* -------------------- –≠–õ–ï–ú–ï–ù–¢–´ --------------------- */
const body = document.body;
const chatEl = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const micBtn = document.getElementById("micBtn");
const webBtn = document.getElementById("webBtn");
const imageInput = document.getElementById("imageInput");
const preview = document.getElementById("preview");
const ocrBtn = document.getElementById("ocrBtn");
const visionBtn = document.getElementById("visionBtn");
const clearBtn = document.getElementById("clearBtn");
const themeToggle = document.getElementById("themeToggle");

/* -------------------- –°–û–°–¢–û–Ø–ù–ò–ï --------------------- */
let llm = null;
let llmReady = false;

let visionModel = null;
let visionReady = false;

let lastImage = null;

let recognition = null;
let speechAvailable = false;

let history = [];
const HISTORY_KEY = "chat_history_v2";
const THEME_KEY = "chat_theme";

/* –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∞–≤—Ç–æ-—Ä–µ–∂–∏–º–∞ "—Ñ–æ—Ç–æ + –∑–∞–¥–∞–Ω–∏–µ" */
const IMAGE_TAGS = ["—Ç–µ–∫—Å—Ç", "–Ω–æ–º–µ—Ä", "–Ω–∞ —Ñ–æ—Ç–æ", "–∫–∞—Ä—Ç–∏–Ω–∫–µ", "–Ω–∞–π–¥–∏"];

/* -------------------- –ò–°–¢–û–†–ò–Ø --------------------- */
function addMessage(role, text, save = true) {
  const m = document.createElement("div");
  m.className = "msg " + role;
  m.textContent = text;
  chatEl.appendChild(m);
  chatEl.scrollTop = chatEl.scrollHeight;

  if (save) {
    history.push({ role, text });
    saveHistory();
  }
}

function addSystem(text) {
  addMessage("system", text);
}

function saveHistory() {
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
}

function loadHistory() {
  const raw = localStorage.getItem(HISTORY_KEY);
  if (!raw) return;
  try {
    history = JSON.parse(raw);
    history.forEach(m => addMessage(m.role, m.text, false));
  } catch {}
}

/* -------------------- –¢–ï–ú–ê --------------------- */
function applyTheme(t) {
  body.classList.remove("dark", "light");
  body.classList.add(t);
  themeToggle.textContent = t === "dark" ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem(THEME_KEY, t);
}

function initTheme() {
  let saved = localStorage.getItem(THEME_KEY);
  if (!saved) {
    saved = window.matchMedia("(prefers-color-scheme: dark)").matches
      ? "dark"
      : "light";
  }
  applyTheme(saved);

  themeToggle.onclick = () => {
    applyTheme(body.classList.contains("dark") ? "light" : "dark");
  };
}

/* -------------------- –ë–õ–û–ö–ò–†–û–í–ö–ê –í–í–û–î–ê --------------------- */
function blockInput() {
  input.disabled = true;
  sendBtn.disabled = true;
  webBtn.disabled = true;
  ocrBtn.disabled = true;
  visionBtn.disabled = true;
  micBtn.disabled = true;
}

function unblockInput() {
  input.disabled = false;
  sendBtn.disabled = false;
  webBtn.disabled = false;
  if (speechAvailable) micBtn.disabled = false;
  if (lastImage) {
    ocrBtn.disabled = false;
    if (visionReady) visionBtn.disabled = false;
  }
}

/* -------------------- WebLLM --------------------- */
async function initLLM() {
  addSystem("–ó–∞–≥—Ä—É–∑–∫–∞ –ò–ò –º–æ–¥–µ–ª–∏... –ü–æ–¥–æ–∂–¥–∏—Ç–µ 10‚Äì30 —Å–µ–∫—É–Ω–¥.");

  try {
    llm = await webllm.ChatModule.create("Llama-3-8B-Instruct-q4f32_1");
    llmReady = true;

    unblockInput();
    input.placeholder = "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...";

    addMessage("ai", "–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!");

  } catch (e) {
    addSystem("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ LLM: " + e);
  }
}

/* -------------------- VISION --------------------- */
async function initVision() {
  try {
    visionModel = await mobilenet.load();
    visionReady = true;
    addSystem("–ú–æ–¥–µ–ª—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.");
  } catch {
    addSystem("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è vision-–º–æ–¥–µ–ª–∏.");
  }
}

/* -------------------- WEB SEARCH --------------------- */
async function webSearch(q) {
  addMessage("user", "/web " + q);
  addMessage("ai", "–ò—â—É –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ...");

  try {
    const url =
      "https://api.allorigins.win/get?url=" +
      encodeURIComponent(
        "https://duckduckgo.com/html/?q=" + encodeURIComponent(q)
      );

    const r = await fetch(url);
    const d = await r.json();
    const doc = new DOMParser().parseFromString(d.contents, "text/html");
    const links = [...doc.querySelectorAll("a.result__a")];

    let out = `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–ª—è "${q}":\n\n`;

    for (let i = 0; i < Math.min(3, links.length); i++) {
      out += `${i + 1}. ${links[i].textContent.trim()}\n${links[i].href}\n\n`;
    }

    chatEl.lastChild.textContent = out;
    history[history.length - 1].text = out;
    saveHistory();

  } catch (e) {
    chatEl.lastChild.textContent = "–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: " + e;
  }
}

webBtn.onclick = () => {
  const q = input.value.trim();
  if (q) {
    input.value = "";
    webSearch(q);
  }
};

/* -------------------- –ì–û–õ–û–°–û–í–û–ô –í–í–û–î --------------------- */
function initSpeech() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    addSystem("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.");
    return;
  }

  recognition = new SR();
  recognition.lang = "ru-RU";

  recognition.onresult = e => {
    input.value = e.results[0][0].transcript;
  };

  speechAvailable = true;
}

micBtn.onclick = () => {
  if (recognition) recognition.start();
  addSystem("–°–ª—É—à–∞—é...");
};

/* -------------------- –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø --------------------- */
imageInput.onchange = () => {
  const f = imageInput.files[0];
  if (!f) return;
  const r = new FileReader();

  r.onload = () => {
    lastImage = r.result;
    preview.src = lastImage;
    preview.style.display = "block";
    ocrBtn.disabled = false;
    if (visionReady) visionBtn.disabled = false;

    addSystem("–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å: ¬´–Ω–∞–π–¥–∏ –Ω–æ–º–µ—Ä¬ª, ¬´–ø—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç¬ª.");
  };

  r.readAsDataURL(f);
};

/* OCR */
ocrBtn.onclick = async () => {
  if (!lastImage) {
    addSystem("–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
    return;
  }

  addMessage("user", "–°–¥–µ–ª–∞–π OCR");
  addMessage("ai", "–ß–∏—Ç–∞—é —Ç–µ–∫—Å—Ç...");

  const res = await Tesseract.recognize(lastImage, "rus+eng");
  const text = res.data.text || "–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.";

  chatEl.lastChild.textContent = text;
};

/* Vision */
visionBtn.onclick = async () => {
  if (!lastImage) return;

  addMessage("user", "–ß—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ?");
  addMessage("ai", "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...");

  const img = new Image();
  img.src = lastImage;

  img.onload = async () => {
    const preds = await visionModel.classify(img);
    let out = "–í–æ—Ç —á—Ç–æ —è –≤–∏–∂—É:\n\n";
    preds.slice(0, 3).forEach((p, i) => {
      out += `${i + 1}. ${p.className} (${Math.round(p.probability * 100)}%)\n`;
    });
    chatEl.lastChild.textContent = out;
  };
};

/* -------------------- –°–ï–ù–î --------------------- */
async function send() {
  if (!llmReady) return;

  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  addMessage("user", text);

  /* –ê–≤—Ç–æ-—Ä–µ–∂–∏–º: —Ñ–æ—Ç–æ + –∑–∞–¥–∞–Ω–∏–µ */
  const matchesImage = lastImage &&
    IMAGE_TAGS.some(k => text.toLowerCase().includes(k));

  if (matchesImage) {
    addMessage("ai", "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–æ—Ç–æ –∏ –≤–∞—à –∑–∞–ø—Ä–æ—Å...");

    let ocrText = "";
    try {
      const r = await Tesseract.recognize(lastImage, "rus+eng");
      ocrText = r.data.text || "";
    } catch {}

    let visionText = "";
    if (visionReady) {
      const img = new Image();
      img.src = lastImage;
      await new Promise(res => (img.onload = res));
      try {
        const preds = await visionModel.classify(img);
        visionText = preds
          .slice(0, 3)
          .map(p => `${p.className} (${Math.round(p.probability * 100)}%)`)
          .join("\n");
      } catch {}
    }

    const prompt = `
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∑–∏–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –¥–∞–ª –∑–∞–¥–∞—á—É: "${text}"

–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:
${ocrText}

–ß—Ç–æ –≤–∏–¥–∏—Ç –º–æ–¥–µ–ª—å:
${visionText}

–û—Ç–≤–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ.`;

    const ans = await llm.generate(prompt);
    chatEl.lastChild.textContent = ans;
    return;
  }

  /* –û–±—ã—á–Ω—ã–π —á–∞—Ç */
  addMessage("ai", "–î—É–º–∞—é...");

  const ans = await llm.generate(text);
  chatEl.lastChild.textContent = ans;
}

sendBtn.onclick = send;
input.onkeydown = e => {
  if (e.key === "Enter") send();
};

/* -------------------- CLEAR --------------------- */
clearBtn.onclick = () => {
  if (confirm("–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) {
    history = [];
    localStorage.removeItem(HISTORY_KEY);
    chatEl.innerHTML = "";
    addSystem("–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.");
  }
};

/* -------------------- START --------------------- */
(function start() {
  initTheme();
  loadHistory();
  blockInput();

  addMessage("ai", "–ü—Ä–∏–≤–µ—Ç! –ò–ò –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ...");

  initSpeech();
  initLLM();
  initVision();
})();
</script>

</body>
</html>
