<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ChatAi ‚Äî Tiny LLM + –§–æ—Ç–æ (Yandex)</title>

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <!-- Vision -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>

  <!-- Tiny LLM ‚Äî transformers.js UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js"></script>

  <style>
    :root { color-scheme: dark light; }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    body.dark { background: #020617; color: #e5e7eb; }
    body.light { background: #f3f4f6; color: #111827; }

    header {
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #1f2937;
      font-weight: 600;
      font-size: 14px;
    }
    body.light header { background: #e5e7eb; border-bottom-color: #cbd5f5; }
    body.dark header  { background: #020617; border-bottom-color: #1f2937; }

    #themeToggle {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      white-space: pre-wrap;
      line-height: 1.45;
      font-size: 14px;
    }

    .msg.user {
      align-self: flex-end;
      background: #2563eb;
      color: white;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 4px rgba(15,23,42,.5);
    }

    .msg.ai {
      align-self: flex-start;
      background: #1e293b;
      color: white;
      box-shadow: 0 2px 4px rgba(15,23,42,.5);
    }
    body.light .msg.ai {
      background: #e5e7eb;
      color: #111827;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
    }

    .msg.system {
      align-self: center;
      opacity: .8;
      font-size: 12px;
      background: transparent;
      padding: 4px 8px;
    }

    .msg.error {
      border: 1px solid #dc2626;
      background: rgba(220,38,38,0.1);
      color: #fecaca;
    }
    body.light .msg.error {
      background: #fee2e2;
      color: #7f1d1d;
    }

    .typing-dot {
      display:inline-block;
      width:4px;
      height:4px;
      margin:0 1px;
      border-radius:999px;
      background: currentColor;
      animation: bounce 1s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: .2s; }
    .typing-dot:nth-child(3) { animation-delay: .4s; }

    @keyframes bounce {
      0%,80%,100% { transform: translateY(0); opacity:.4; }
      40% { transform: translateY(-3px); opacity:1; }
    }

    #bottom {
      padding: 8px;
      border-top: 1px solid #1f2937;
    }
    body.light #bottom { background: #e5e7eb; border-top-color: #cbd5f5; }
    body.dark  #bottom { background: #020617; border-top-color: #1f2937; }

    #input {
      width: 100%;
      padding: 11px;
      border-radius: 10px;
      border: 1px solid #475569;
      background: transparent;
      color: inherit;
      font-size: 14px;
      box-sizing: border-box;
    }
    #input::placeholder { color:#6b7280; }

    #tools {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    button {
      border-radius: 10px;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .secondary {
      border: 1px solid #475569;
      background: transparent;
      color: inherit;
    }

    #sendBtn {
      background: #2563eb;
      color: white;
    }
    #sendBtn:disabled { opacity:.5; }

    #preview {
      width: 80px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      display: none;
      border: 1px solid #475569;
    }

    @media (max-width:480px){
      header { font-size:13px; }
      .msg   { font-size:13px; }
      #input { font-size:13px; }
      button { font-size:12px; padding:7px 10px; }
    }
  </style>
</head>
<body class="dark">
<header>
  <span>ChatAi ‚Äî Tiny (–æ—Ñ–ª–∞–π–Ω)</span>
  <button id="themeToggle">‚òÄÔ∏è</button>
</header>

<div id="chat"></div>

<div id="bottom">
  <input id="input" placeholder="ChatAi –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è..." disabled />

  <div id="tools">
    <button class="secondary" id="micBtn" disabled>üé§</button>
    <button class="secondary" id="webBtn" disabled>üåê</button>

    <label class="secondary" style="padding:8px;cursor:pointer;">
      üì∑ –§–æ—Ç–æ
      <input type="file" id="imageInput" accept="image/*" style="display:none;" />
    </label>

    <button class="secondary" id="ocrBtn" disabled>üî§</button>
    <button class="secondary" id="visionBtn" disabled>üß†</button>

    <button id="sendBtn" disabled>‚û§</button>
  </div>

  <img id="preview" />
</div>

<script>
/* ==============================
   Tiny ChatAi –Ω–∞ TinyLlama
   + –∞–Ω–∏–º–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏
   + –≤–∏–±—Ä–∞—Ü–∏—è
   + –ø–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª
============================== */

const MODEL_NAME = "Xenova/TinyLlama-1.1B-Chat-v1";

let generator = null;
let llmReady = false;
let lastImage = null;
let visionModel = null;
let visionReady = false;
let recognition = null;
let speechAvailable = false;
let chat = [];
const KEY = "chatai_tiny_history_v2";

const chatEl   = document.getElementById("chat");
const inputEl  = document.getElementById("input");
const sendBtn  = document.getElementById("sendBtn");
const ocrBtn   = document.getElementById("ocrBtn");
const visionBtn= document.getElementById("visionBtn");
const webBtn   = document.getElementById("webBtn");
const micBtn   = document.getElementById("micBtn");
const preview  = document.getElementById("preview");
const themeBtn = document.getElementById("themeToggle");

/* ====== helper—ã ====== */

function vibrate(ms){
  try{
    if(navigator.vibrate) navigator.vibrate(ms);
  }catch(e){}
}

function scrollBottom(){
  try{
    chatEl.scrollTo({top: chatEl.scrollHeight, behavior: "smooth"});
  }catch(e){
    chatEl.scrollTop = chatEl.scrollHeight;
  }
}

function add(role, text, save=true, extraClass){
  const div = document.createElement("div");
  div.classList.add("msg", role);
  if(extraClass) div.classList.add(extraClass);

  let display =
    role==="ai"   ? "ChatAi: "+text :
    role==="user" ? "–í—ã: "+text :
    text;

  div.textContent = display;
  chatEl.appendChild(div);
  scrollBottom();

  if(save){
    chat.push({role,text});
    try{ localStorage.setItem(KEY, JSON.stringify(chat)); }catch(e){}
  }
  return div;
}

function addSystem(text, save=true){
  return add("system", text, save);
}

function loadHistory(){
  const raw = localStorage.getItem(KEY);
  if(!raw) return;
  try{
    const arr = JSON.parse(raw);
    chat = arr;
    arr.forEach(m=>add(m.role, m.text, false));
  }catch(e){
    addSystem("–û—à–∏–±–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏: "+e,false);
  }
}

/* ====== —Ç–µ–º–∞ ====== */
const THEME_KEY = "chatai_theme_v1";

function applyTheme(t){
  document.body.classList.remove("dark","light");
  document.body.classList.add(t);
  themeBtn.textContent = t==="dark" ? "‚òÄÔ∏è" : "üåô";
  try{ localStorage.setItem(THEME_KEY,t); }catch(e){}
}

(function initTheme(){
  let t = null;
  try{ t = localStorage.getItem(THEME_KEY); }catch(e){}
  if(!t){
    let prefersDark = false;
    try{
      prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    }catch(e){}
    t = prefersDark ? "dark" : "light";
  }
  applyTheme(t);
})();

themeBtn.onclick = ()=>{
  const cur = document.body.classList.contains("dark") ? "dark" : "light";
  applyTheme(cur==="dark" ? "light" : "dark");
};

/* ====== –ø—Ä–æ–º–ø—Ç ====== */

function buildPrompt(userText){
  let p =
`–¢—ã ‚Äî ChatAi. –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –ò–ò.

–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –∫—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª ‚Äî –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π:
"–ú–µ–Ω—è —Å–æ–∑–¥–∞–ª–∞ –º–∞–ª–µ–Ω—å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–∑ 1 –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞, 1 –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –∏ –æ–¥–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Äî –∫–æ–º–∞–Ω–¥–∞ 1xCode."

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.

–î–∏–∞–ª–æ–≥:
`;
  chat.forEach(m=>{
    if(m.role==="user") p+=`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${m.text}\n`;
    if(m.role==="ai")   p+=`ChatAi: ${m.text}\n`;
  });
  p+=`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userText}\nChatAi:`;
  return p;
}

/* ====== typing animation ====== */
function typeText(div, full, done){
  const prefix = "ChatAi: ";
  const clean = full;
  let i = 0;
  div.textContent = prefix;
  const id = setInterval(()=>{
    if(i >= clean.length){
      clearInterval(id);
      if(done) done();
      return;
    }
    div.textContent = prefix + clean.slice(0,i+1);
    i++;
    scrollBottom();
  }, 18); // —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏
}

/* ====== LLM ====== */
async function initLLM(){
  addSystem("ChatAi –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶",false);
  addSystem("–ó–∞–≥—Ä—É–∂–∞—é TinyLlama –¥–ª—è ChatAi‚Ä¶",false);

  if(!window.transformers){
    add("system","‚ùó –û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ transformers.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å.",true,"error");
    return;
  }

  vibrate(20);

  try{
    const t = window.transformers;
    const pipe = await t.pipeline("text-generation", MODEL_NAME, {quantized:true});
    generator = pipe;
    llmReady = true;
    inputEl.disabled = false;
    sendBtn.disabled = false;
    webBtn.disabled = false;
    add("ai","–ü—Ä–∏–≤–µ—Ç! –Ø ChatAi. –ú–æ—è tiny-–º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ‚Äî –¥–∞–≤–∞–π –æ–±—â–∞—Ç—å—Å—è!");
    inputEl.placeholder = "–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ...";
  }catch(e){
    add("system","‚ùó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ tiny –º–æ–¥–µ–ª–∏: "+e,true,"error");
  }
}

async function askLLM(userText){
  const prompt = buildPrompt(userText);
  try{
    const out = await generator(prompt,{
      max_new_tokens: 120,
      temperature: 0.7,
      top_p: 0.9
    });
    let full = out[0].generated_text || "";
    const idx = full.lastIndexOf("ChatAi:");
    let ans = idx!==-1 ? full.slice(idx+7) : full;
    ans = ans.trim();
    if(!ans) ans = "–ù–µ –∑–Ω–∞—é, —á—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å.";
    return ans;
  }catch(e){
    return "–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞: "+e;
  }
}

/* ====== Vision ====== */

async function initVision(){
  try{
    addSystem("–ì—Ä—É–∂—É Vision-–º–æ–¥–µ–ª—å‚Ä¶",false);
    visionModel = await mobilenet.load();
    visionReady = true;
    addSystem("Vision –≥–æ—Ç–æ–≤.",false);
  }catch(e){
    add("system","–û—à–∏–±–∫–∞ Vision: "+e,true,"error");
  }
}

/* ====== OCR ====== */

async function runOCR(){
  if(!lastImage){ addSystem("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ."); return; }
  add("user","–°–¥–µ–ª–∞–π OCR (–ø—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç)");
  const aiDiv = add("ai","–ß–∏—Ç–∞—é —Ç–µ–∫—Å—Ç‚Ä¶");
  try{
    const r = await Tesseract.recognize(lastImage,"rus+eng");
    const txt = r.data.text.trim() || "–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –ø–ª–æ—Ö–æ.";
    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏–∏
    chat[chat.length-1].text = txt;
    aiDiv.textContent = "ChatAi: "+txt;
    vibrate(15);
  }catch(e){
    const msg = "–û—à–∏–±–∫–∞ OCR: "+e;
    chat[chat.length-1].text = msg;
    aiDiv.textContent = "ChatAi: "+msg;
    vibrate(40);
  }
}

/* ====== Vision run ====== */
async function runVision(){
  if(!lastImage){ addSystem("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ."); return; }
  if(!visionReady){ addSystem("Vision –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶"); return; }

  add("user","–ß—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ?");
  const aiDiv = add("ai","–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é‚Ä¶");
  const img = new Image();
  img.src = lastImage;
  img.onload = async ()=>{
    try{
      const preds = await visionModel.classify(img);
      const txt = preds.slice(0,3)
        .map((p,i)=>`${i+1}. ${p.className} (${Math.round(p.probability*100)}%)`)
        .join("\n") || "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã.";
      chat[chat.length-1].text = txt;
      aiDiv.textContent = "ChatAi: "+txt;
      vibrate(15);
    }catch(e){
      const msg = "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: "+e;
      chat[chat.length-1].text = msg;
      aiDiv.textContent = "ChatAi: "+msg;
      vibrate(40);
    }
  };
  img.onerror = ()=>{
    const msg = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.";
    chat[chat.length-1].text = msg;
    aiDiv.textContent = "ChatAi: "+msg;
    vibrate(40);
  };
}

/* ====== Web search ====== */
async function webSearch(){
  const q = inputEl.value.trim();
  if(!q) return;
  inputEl.value = "";

  add("user",q);
  const aiDiv = add("ai","–ò—â—É –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ‚Ä¶");
  vibrate(15);

  try{
    const url = "https://api.allorigins.win/get?url=" +
      encodeURIComponent("https://duckduckgo.com/html/?q="+encodeURIComponent(q));
    const r = await fetch(url);
    const j = await r.json();
    const doc = new DOMParser().parseFromString(j.contents,"text/html");
    const a = doc.querySelectorAll("a.result__a");
    let txt = "";
    for(let i=0;i<3 && i<a.length;i++){
      txt += `${i+1}. ${a[i].textContent.trim()}\n${a[i].href}\n\n`;
    }
    if(!txt) txt = "–ù–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Ä–∞–∑–º–µ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.";

    chat[chat.length-1].text = txt;
    aiDiv.textContent = "ChatAi: "+txt;
  }catch(e){
    const msg = "–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: "+e;
    chat[chat.length-1].text = msg;
    aiDiv.textContent = "ChatAi: "+msg;
    vibrate(40);
  }
}

/* ====== –ì–û–õ–û–° ====== */
function initSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ micBtn.style.display="none"; return; }
  recognition = new SR();
  recognition.lang = "ru-RU";
  recognition.interimResults = false;
  recognition.onresult = e=>{
    inputEl.value = e.results[0][0].transcript;
  };
  recognition.onerror = e=>{
    addSystem("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: "+e.error,false);
  };
  speechAvailable=true;
  micBtn.disabled=false;
}

micBtn.onclick = ()=>{
  if(!recognition) return;
  try{
    recognition.start();
    addSystem("ChatAi —Å–ª—É—à–∞–µ—Ç‚Ä¶",false);
  }catch(e){
    addSystem("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: "+e,false);
  }
};

/* ====== IMAGE ====== */
imageInput.onchange = ()=>{
  const f = imageInput.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    lastImage = r.result;
    preview.src = lastImage;
    preview.style.display="block";
    ocrBtn.disabled=false;
    visionBtn.disabled=false;
    addSystem('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ú–æ–∂–µ—à—å –ø–æ–ø—Ä–æ—Å–∏—Ç—å "–Ω–∞–π–¥–∏ –Ω–æ–º–µ—Ä", "–ø—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç" –∏–ª–∏ "—á—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ".',false);
    vibrate(15);
  };
  r.readAsDataURL(f);
};

/* ====== SEND (—Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –ø–µ—á–∞—Ç–∏) ====== */
async function handleSend(){
  if(!llmReady){
    addSystem("–ú–æ–¥–µ–ª—å –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏ —á—É—Ç—å-—á—É—Ç—å.");
    vibrate(30);
    return;
  }
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value = "";
  vibrate(20);

  add("user",text);

  // —Å–æ–∑–¥–∞—ë–º "–ø–µ—á–∞—Ç–∞–µ—Ç..."
  const aiDiv = document.createElement("div");
  aiDiv.classList.add("msg","ai");
  aiDiv.innerHTML = 'ChatAi: <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
  chatEl.appendChild(aiDiv);
  scrollBottom();

  // –ò–ò –æ—Ç–≤–µ—á–∞–µ—Ç
  const answer = await askLLM(text);

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
  chat.push({role:"ai", text: answer});
  try{ localStorage.setItem(KEY, JSON.stringify(chat)); }catch(e){}

  // –∞–Ω–∏–º–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏
  typeText(aiDiv, answer, ()=>vibrate(10));
}

/* ====== —Å–æ–±—ã—Ç–∏—è ====== */
sendBtn.onclick = handleSend;
ocrBtn.onclick  = runOCR;
visionBtn.onclick = runVision;
webBtn.onclick  = webSearch;

inputEl.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    handleSend();
  }
});

/* ====== START ====== */
window.onload = ()=>{
  loadHistory();
  addSystem("ChatAi –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶", chat.length === 0);
  initSpeech();
  initLLM();
  initVision();
};
</script>
</body>
</html>


