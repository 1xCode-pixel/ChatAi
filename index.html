<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>AI Chat ‚Äî Mobile, History, Voice, Images</title>

  <!-- LLM -->
  <script src="https://unpkg.com/@mlc-ai/web-llm"></script>

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <!-- Vision -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

  <style>
    :root {
      color-scheme: dark light;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ----- –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ----- */
    body.dark {
      background: #020617;
      color: #e5e7eb;
    }

    body.dark header {
      background: #020617;
      border-bottom: 1px solid #1f2937;
      color: #e5e7eb;
    }

    body.dark #bottom {
      background: #020617;
      border-top: 1px solid #1f2937;
    }

    body.dark #input {
      background: #0f172a;
      border: 1px solid #334155;
      color: #e5e7eb;
    }

    body.dark .msg.ai {
      background: #1e293b;
      color: #e5e7eb;
    }

    body.dark .msg.user {
      background: #2563eb;
      color: #ffffff;
    }

    body.dark .secondary,
    body.dark label.file-label {
      background: #0f172a;
      color: #e5e7eb;
      border-color: #4b5563;
    }

    /* ----- –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê ----- */
    body.light {
      background: #f3f4f6;
      color: #111827;
    }

    body.light header {
      background: #e5e7eb;
      border-bottom: 1px solid #cbd5f5;
      color: #111827;
    }

    body.light #bottom {
      background: #e5e7eb;
      border-top: 1px solid #cbd5f5;
    }

    body.light #input {
      background: #ffffff;
      border: 1px solid #cbd5f5;
      color: #111827;
    }

    body.light .msg.ai {
      background: #e5e7eb;
      color: #111827;
    }

    body.light .msg.user {
      background: #2563eb;
      color: #ffffff;
    }

    body.light .secondary,
    body.light label.file-label {
      background: #ffffff;
      color: #111827;
      border-color: #cbd5f5;
    }

    /* ----- –û–±—â–µ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ ----- */
    header {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 15px;
      font-weight: 600;
    }

    #themeToggle {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 16px;
      cursor: pointer;
      background: transparent;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.45;
    }

    .msg.user {
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .msg.ai {
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .msg.system {
      align-self: center;
      font-size: 12px;
      opacity: 0.7;
      background: transparent;
      padding: 4px 8px;
    }

    #bottom {
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #input-row {
      display: flex;
      gap: 6px;
    }

    #input {
      flex: 1;
      padding: 11px;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
    }

    button {
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 11px 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    #sendBtn {
      background: #2563eb;
      color: white;
    }
    #sendBtn:disabled {
      opacity: 0.5;
    }

    .secondary {
      border: 1px solid transparent;
      font-size: 13px;
    }

    #tools {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .tools-left,
    .tools-right {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    label.file-label {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px dashed;
      font-size: 13px;
      cursor: pointer;
    }

    #imageInput {
      display: none;
    }

    #preview {
      max-width: 90px;
      max-height: 60px;
      border-radius: 8px;
      object-fit: cover;
      display: none;
      border: 1px solid #4b5563;
    }

    #clearBtn {
      font-size: 12px;
      padding: 8px 10px;
    }

    @media (max-width: 480px) {
      header {
        font-size: 14px;
      }
      .msg {
        font-size: 13px;
      }
      button {
        font-size: 13px;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
<header>
  <span>–ò–ò-—á–∞—Ç (–∏—Å—Ç–æ—Ä–∏—è, –≥–æ–ª–æ—Å, —Ñ–æ—Ç–æ)</span>
  <button id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
</header>

<div id="chat"></div>

<div id="bottom">
  <div id="input-row">
    <input id="input" placeholder="–ñ–¥–∏—Ç–µ... –ò–ò —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è" disabled>
    <button class="secondary" id="micBtn" disabled title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
    <button id="sendBtn" disabled title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
  </div>

  <div id="tools">
    <div class="tools-left">
      <button class="secondary" id="webBtn" disabled>üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç</button>

      <label class="file-label secondary">
        üì∑ –§–æ—Ç–æ
        <input type="file" id="imageInput" accept="image/*">
      </label>

      <img id="preview" alt="preview">
    </div>

    <div class="tools-right">
      <button class="secondary" id="ocrBtn" disabled>üî§ OCR</button>
      <button class="secondary" id="visionBtn" disabled>üß† –§–æ—Ç–æ</button>
      <button class="secondary" id="clearBtn">üóë –ß–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    </div>
  </div>
</div>

<script>
  // ---------- –≠–õ–ï–ú–ï–ù–¢–´ ----------
  const body = document.body;
  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const micBtn = document.getElementById('micBtn');
  const webBtn = document.getElementById('webBtn');
  const ocrBtn = document.getElementById('ocrBtn');
  const visionBtn = document.getElementById('visionBtn');
  const imageInput = document.getElementById('imageInput');
  const previewImg = document.getElementById('preview');
  const clearBtn = document.getElementById('clearBtn');
  const themeToggleBtn = document.getElementById('themeToggle');

  // ---------- –°–û–°–¢–û–Ø–ù–ò–ï ----------
  let llm = null;
  let llmReady = false;

  let visionModel = null;
  let visionReady = false;

  let lastImageDataUrl = null;

  let recognition = null;
  let speechAvailable = false;

  let chatHistory = [];
  const HISTORY_KEY = 'ai_chat_history_v1';
  const THEME_KEY = 'ai_chat_theme_v1';

  const IMAGE_KEYWORDS = [
    '–Ω–æ–º–µ—Ä', '—Ç–µ–∫—Å—Ç', '–Ω–∞ —Ñ–æ—Ç–æ', '–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ',
    '—Å —Ñ–æ—Ç–æ', '—Å –∫–∞—Ä—Ç–∏–Ω–∫–∏', '—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'
  ];

  // ---------- –¢–ï–ú–ê ----------
  function applyTheme(theme) {
    body.classList.remove('light', 'dark');
    body.classList.add(theme);
    themeToggleBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem(THEME_KEY, theme);
  }

  function initTheme() {
    let saved = localStorage.getItem(THEME_KEY);
    if (!saved) {
      const prefersDark = window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches;
      saved = prefersDark ? 'dark' : 'light';
    }
    applyTheme(saved);

    themeToggleBtn.addEventListener('click', () => {
      const current = body.classList.contains('dark') ? 'dark' : 'light';
      applyTheme(current === 'dark' ? 'light' : 'dark');
    });
  }

  // ---------- –ò–°–¢–û–†–ò–Ø –ß–ê–¢–ê ----------
  function saveHistory() {
    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
    } catch (e) {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é:', e);
    }
  }

  function addMessage(role, text, save = true) {
    const div = document.createElement('div');
    div.classList.add('msg', role);
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;

    if (save) {
      chatHistory.push({ role, text });
      saveHistory();
    }
  }

  function addSystem(text, save = true) {
    addMessage('system', text, save);
  }

  function loadHistory() {
    const raw = localStorage.getItem(HISTORY_KEY);
    if (!raw) return;
    try {
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return;
      chatHistory = arr;
      arr.forEach(msg => {
        if (!msg || !msg.role) return;
        addMessage(msg.role, msg.text, false);
      });
    } catch (e) {
      console.warn('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', e);
    }
  }

  function clearHistory() {
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç? –ò—Å—Ç–æ—Ä–∏—é –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.')) return;
    chatHistory = [];
    localStorage.removeItem(HISTORY_KEY);
    chatEl.innerHTML = '';
    addSystem('–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ò—Å—Ç–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.');
  }

  clearBtn.addEventListener('click', clearHistory);

  // ---------- –ë–õ–û–ö–ò–†–û–í–ö–ê –í–í–û–î–ê ----------
  function blockInput() {
    inputEl.disabled = true;
    sendBtn.disabled = true;
    webBtn.disabled = true;
    ocrBtn.disabled = true;
    visionBtn.disabled = true;
    micBtn.disabled = true;
  }

  function unblockInput() {
    inputEl.disabled = false;
    sendBtn.disabled = false;
    webBtn.disabled = false;
    if (lastImageDataUrl) {
      ocrBtn.disabled = false;
      if (visionReady) visionBtn.disabled = false;
    }
    if (speechAvailable) micBtn.disabled = false;
  }

  // ---------- LLM ----------
  async function initLLM() {
    addSystem('–ó–∞–≥—Ä—É–∑–∫–∞ –ò–ò –º–æ–¥–µ–ª–∏... –ü–æ–¥–æ–∂–¥–∏—Ç–µ 10‚Äì30 —Å–µ–∫—É–Ω–¥.');

    try {
      llm = await webllm.ChatModule.create("Llama-3-8B-Instruct-q4f32_1");
      llmReady = true;

      unblockInput();
      inputEl.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...';

      addMessage('ai', '–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!');

    } catch (e) {
      addSystem('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ LLM: ' + e);
    }
  }

  // ---------- VISION ----------
  async function initVision() {
    try {
      visionModel = await mobilenet.load();
      visionReady = true;
      addSystem('–ú–æ–¥–µ–ª—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞.', false);
    } catch (e) {
      addSystem('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ vision: ' + e, false);
    }
  }

  // ---------- WEB SEARCH ----------
  async function webSearch(query) {
    const q = query || inputEl.value.trim();
    if (!q) return;
    inputEl.value = '';

    addMessage('user', '/web ' + q);
    addMessage('ai', '–ò—â—É –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ...');

    try {
      const url = 'https://api.allorigins.win/get?url=' +
        encodeURIComponent('https://duckduckgo.com/html/?q=' + encodeURIComponent(q));

      const resp = await fetch(url);
      const data = await resp.json();
      const html = data.contents;

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const links = Array.from(doc.querySelectorAll('a.result__a'));

      let text = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "' + q + '"\n\n';
      for (let i = 0; i < Math.min(3, links.length); i++) {
        const a = links[i];
        text += `${i + 1}. ${a.textContent.trim()}\n${a.href}\n\n`;
      }
      if (links.length === 0) {
        text += '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Ä–∞–∑–º–µ—Ç–∫–∞ –º–æ–≥–ª–∞ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è).';
      }

      chatEl.lastChild.textContent = text;
      chatHistory[chatHistory.length - 1].text = text;
      saveHistory();

    } catch (e) {
      chatEl.lastChild.textContent = '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + e;
      chatHistory[chatHistory.length - 1].text = '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + e;
      saveHistory();
    }
  }

  webBtn.addEventListener('click', () => webSearch());

  // ---------- –ì–û–õ–û–°–û–í–û–ô –í–í–û–î ----------
  function initSpeech() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      addSystem('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.', false);
      micBtn.style.display = 'none';
      return;
    }
    recognition = new SR();
    recognition.lang = 'ru-RU';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event) => {
      const text = event.results[0][0].transcript;
      inputEl.value = text;
    };

    recognition.onerror = (event) => {
      addSystem('–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: ' + event.error, false);
    };

    speechAvailable = true;
    if (llmReady) micBtn.disabled = false;
  }

  micBtn.addEventListener('click', () => {
    if (!recognition) return;
    try {
      recognition.start();
      addSystem('–°–ª—É—à–∞—é... –°–∫–∞–∂–∏ —Ñ—Ä–∞–∑—É, –∑–∞—Ç–µ–º –æ—Ç–ø—É—Å—Ç–∏ –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.', false);
    } catch (e) {
      addSystem('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏: ' + e, false);
    }
  });

  // ---------- –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø, OCR, VISION ----------
  imageInput.addEventListener('change', () => {
    const file = imageInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      lastImageDataUrl = reader.result;
      previewImg.src = lastImageDataUrl;
      previewImg.style.display = 'block';
      ocrBtn.disabled = false;
      if (visionReady) visionBtn.disabled = false;
      addSystem('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ú–æ–∂–µ—à—å –ø–æ–ø—Ä–æ—Å–∏—Ç—å: "–Ω–∞–π–¥–∏ –Ω–æ–º–µ—Ä", "–ø—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ñ–æ—Ç–æ" –∏ —Ç.–ø.', true);
    };
    reader.readAsDataURL(file);
  });

  async function runOCR() {
    if (!lastImageDataUrl) {
      addSystem('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É.', false);
      return;
    }
    addMessage('user', '–°–¥–µ–ª–∞–π OCR —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏');
    addMessage('ai', '–ß–∏—Ç–∞—é —Ç–µ–∫—Å—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');

    try {
      const result = await Tesseract.recognize(lastImageDataUrl, 'rus+eng');
      const text = result.data && result.data.text ? result.data.text.trim() : '';
      const answer = text ? ('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:\n' + text) : '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –ø–ª–æ—Ö–æ.';

      chatEl.lastChild.textContent = answer;
      chatHistory[chatHistory.length - 1].text = answer;
      saveHistory();
    } catch (e) {
      chatEl.lastChild.textContent = '–û—à–∏–±–∫–∞ OCR: ' + e;
      chatHistory[chatHistory.length - 1].text = '–û—à–∏–±–∫–∞ OCR: ' + e;
      saveHistory();
    }
  }

  async function runVision() {
    if (!lastImageDataUrl) {
      addSystem('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É.', false);
      return;
    }
    if (!visionReady) {
      addSystem('–ú–æ–¥–µ–ª—å –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è.', false);
      return;
    }

    addMessage('user', '–ß—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ?');
    addMessage('ai', '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...');

    const img = new Image();
    img.src = lastImageDataUrl;
    img.onload = async () => {
      try {
        const predictions = await visionModel.classify(img);
        let text = '–ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è:\n\n';
        predictions.slice(0, 3).forEach((p, i) => {
          text += `${i + 1}. ${p.className} (${Math.round(p.probability * 100)}%)\n`;
        });

        chatEl.lastChild.textContent = text;
        chatHistory[chatHistory.length - 1].text = text;
        saveHistory();
      } catch (e) {
        chatEl.lastChild.textContent = '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + e;
        chatHistory[chatHistory.length - 1].text = '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + e;
        saveHistory();
      }
    };
    img.onerror = () => {
      chatEl.lastChild.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.';
      chatHistory[chatHistory.length - 1].text = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.';
      saveHistory();
    };
  }

  ocrBtn.addEventListener('click', runOCR);
  visionBtn.addEventListener('click', runVision);

  // ---------- –ß–ê–¢ + –õ–û–ì–ò–ö–ê "–§–û–¢–û + –ó–ê–î–ê–ù–ò–ï" ----------
  async function handleSend() {
    if (!llmReady) {
      addSystem('–ú–æ–¥–µ–ª—å –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è. –ü–æ–¥–æ–∂–¥–∏—Ç–µ —á—É—Ç—å-—á—É—Ç—å.', false);
      return;
    }
    const text = inputEl.value.trim();
    if (!text) return;
    inputEl.value = '';

    addMessage('user', text);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º—É —Ñ–æ—Ç–æ
    const lower = text.toLowerCase();
    const refersToImage = lastImageDataUrl &&
      IMAGE_KEYWORDS.some(k => lower.includes(k));

    if (refersToImage) {
      // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º: —Å–Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ, –ø–æ—Ç–æ–º LLM –¥–∞—ë—Ç –æ—Ç–≤–µ—Ç
      addMessage('ai', '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–æ—Ç–æ –∏ –≤–∞—à –∑–∞–ø—Ä–æ—Å...');

      try {
        let ocrText = '';
        try {
          const res = await Tesseract.recognize(lastImageDataUrl, 'rus+eng');
          ocrText = res.data && res.data.text ? res.data.text.trim() : '';
        } catch (e) {
          console.warn('OCR error in combined mode:', e);
        }

        let visionSummary = '';
        if (visionReady) {
          const img = new Image();
          img.src = lastImageDataUrl;
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
          });
          try {
            const preds = await visionModel.classify(img);
            visionSummary = preds.slice(0, 3)
              .map((p, i) => `${i + 1}. ${p.className} (${Math.round(p.probability * 100)}%)`)
              .join('\n');
          } catch (e) {
            console.warn('Vision error in combined mode:', e);
          }
        }

        let prompt = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∑–∏–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –Ω–∞–ø–∏—Å–∞–ª –∑–∞–¥–∞—á—É: "${text}".\n`;
        if (ocrText) {
          prompt += `–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏:\n${ocrText}\n\n`;
        }
        if (visionSummary) {
          prompt += `–ú–æ–¥–µ–ª—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≤–∏–¥–∏—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏:\n${visionSummary}\n\n`;
        }
        prompt += '–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ—Å–∏—Ç "–Ω–æ–º–µ—Ä", ' +
                  '—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Ä–µ—á—å –æ –Ω–æ–º–µ—Ä–µ –∏–ª–∏ —Ç–µ–∫—Å—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ. –û–±—ä—è—Å–Ω–∏ –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º, —á—Ç–æ –Ω–∞—à—ë–ª.';

        const answer = await llm.generate(prompt);

        chatEl.lastChild.textContent = answer;
        chatHistory[chatHistory.length - 1].text = answer;
        saveHistory();

      } catch (e) {
        chatEl.lastChild.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∑–∞–ø—Ä–æ—Å–∞: ' + e;
        chatHistory[chatHistory.length - 1].text =
          '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∑–∞–ø—Ä–æ—Å–∞: ' + e;
        saveHistory();
      }
      return;
    }

    // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º: –ø—Ä–æ—Å—Ç–æ —á–∞—Ç
    addMessage('ai', '–î—É–º–∞—é...');

    try {
      const answer = await llm.generate(text);
      chatEl.lastChild.textContent = answer;
      chatHistory[chatHistory.length - 1].text = answer;
      saveHistory();
    } catch (e) {
      chatEl.lastChild.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞: ' + e;
      chatHistory[chatHistory.length - 1].text = '–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞: ' + e;
      saveHistory();
    }
  }

  sendBtn.addEventListener('click', handleSend);
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  // ---------- –°–¢–ê–†–¢ ----------
  (function start() {
    initTheme();
    loadHistory();

    if (chatHistory.length === 0) {
      addMessage('ai', '–ü—Ä–∏–≤–µ—Ç! –Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ü–æ–¥–æ–∂–¥–∏, –ø–æ–∫–∞ —è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂—É—Å—å, –∞ –ø–æ—Ç–æ–º –º–æ–∂–µ–º –æ–±—â–∞—Ç—å—Å—è.');
    }

    blockInput();
    initSpeech();
    initLLM();
    initVision();
  })();
</script>
</body>
</html>
